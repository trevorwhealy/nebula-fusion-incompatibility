'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.SELECTION_TYPE = undefined;

var _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; };

var _slicedToArray = function () { function sliceIterator(arr, i) { var _arr = []; var _n = true; var _d = false; var _e = undefined; try { for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i["return"]) _i["return"](); } finally { if (_d) throw _e; } } return _arr; } return function (arr, i) { if (Array.isArray(arr)) { return arr; } else if (Symbol.iterator in Object(arr)) { return sliceIterator(arr, i); } else { throw new TypeError("Invalid attempt to destructure non-iterable instance"); } }; }();

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

var _deck = require('deck.gl');

var _helpers = require('@turf/helpers');

var _bbox = require('@turf/bbox');

var _bbox2 = _interopRequireDefault(_bbox);

var _bboxPolygon = require('@turf/bbox-polygon');

var _bboxPolygon2 = _interopRequireDefault(_bboxPolygon);

var _buffer = require('@turf/buffer');

var _buffer2 = _interopRequireDefault(_buffer);

var _difference = require('@turf/difference');

var _difference2 = _interopRequireDefault(_difference);

var _distance = require('@turf/distance');

var _distance2 = _interopRequireDefault(_distance);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var POLYGON_LINE_COLOR = [0, 255, 0, 255];
var POLYGON_FILL_COLOR = [255, 255, 255, 90];
var POLYGON_LINE_WIDTH = 2;
var POLYGON_DASHES = [20, 20];
var POLYGON_THRESHOLD = 0.01;
var EXPANSION_KM = 10;
var LAYER_ID_VIEW = 'DeckDrawerView';
var LAYER_ID_PICK = 'DeckDrawerPick';

var SELECTION_TYPE = exports.SELECTION_TYPE = {
  NONE: 0,
  RECTANGLE: 1,
  POLYGON: 2
};

var DeckDrawer = function () {
  function DeckDrawer(nebula) {
    var _this = this;

    _classCallCheck(this, DeckDrawer);

    this._getPolygon = function (o) {
      var coordsToLngLatOffset = _this.nebula.projector.coordsToLngLatOffset;


      if (Array.isArray(o.polygon[0][0])) {
        // complex polygon with holes
        return o.polygon.map(function (a) {
          return a.map(coordsToLngLatOffset);
        });
      }

      // simple polygon
      return o.polygon.map(coordsToLngLatOffset);
    };

    this.nebula = nebula;
    this.usePolygon = false;
    this.landPoints = [];
    this.mousePoints = [];
  }

  _createClass(DeckDrawer, [{
    key: '_getLayerIds',
    value: function _getLayerIds() {
      // TODO: sort by mouse priority
      return this.nebula.deckgl.props.layers.filter(function (l) {
        return l && l.props && l.props.nebulaLayer && l.props.nebulaLayer.enableSelection;
      }).map(function (l) {
        return l.id;
      });
    }
  }, {
    key: '_selectFromPickingInfos',
    value: function _selectFromPickingInfos(pickingInfos) {
      var objects = pickingInfos.map(function (_ref) {
        var layer = _ref.layer,
            index = _ref.index,
            object = _ref.object;
        return object.original || layer.props.nebulaLayer.deckCache.originals[index];
      });
      this.nebula.props.onSelection(objects);
    }
  }, {
    key: '_getBoundingBox',
    value: function _getBoundingBox() {
      var mousePoints = this.mousePoints;

      var allX = mousePoints.map(function (mousePoint) {
        return mousePoint[0];
      });
      var allY = mousePoints.map(function (mousePoint) {
        return mousePoint[1];
      });
      var x = Math.min.apply(Math, _toConsumableArray(allX));
      var y = Math.min.apply(Math, _toConsumableArray(allY));
      var maxX = Math.max.apply(Math, _toConsumableArray(allX));
      var maxY = Math.max.apply(Math, _toConsumableArray(allY));

      return { x: x, y: y, width: maxX - x, height: maxY - y };
    }
  }, {
    key: '_selectRectangleObjects',
    value: function _selectRectangleObjects() {
      if (this.landPoints.length !== 2) return;

      var _mousePoints$ = _slicedToArray(this.mousePoints[0], 2),
          x1 = _mousePoints$[0],
          y1 = _mousePoints$[1];

      var _mousePoints$2 = _slicedToArray(this.mousePoints[1], 2),
          x2 = _mousePoints$2[0],
          y2 = _mousePoints$2[1];

      var pickingInfos = this.nebula.deckgl.queryVisibleObjects({
        x: Math.min(x1, x2),
        y: Math.min(y1, y2),
        width: Math.abs(x2 - x1),
        height: Math.abs(y2 - y1),
        layerIds: this._getLayerIds()
      });

      this._selectFromPickingInfos(pickingInfos);
    }
  }, {
    key: '_selectPolygonObjects',
    value: function _selectPolygonObjects() {
      var pickingInfos = this.nebula.deckgl.queryVisibleObjects(_extends({}, this._getBoundingBox(), {
        layerIds: [LAYER_ID_PICK].concat(_toConsumableArray(this._getLayerIds()))
      }));

      this._selectFromPickingInfos(pickingInfos.filter(function (item) {
        return item.layer.id !== LAYER_ID_PICK;
      }));
    }
  }, {
    key: '_getMousePosFromEvent',
    value: function _getMousePosFromEvent(event) {
      var offsetX = event.offsetX,
          offsetY = event.offsetY;

      return [offsetX, offsetY];
    }
  }, {
    key: 'handleEvent',
    value: function handleEvent(event, lngLat, selectionType) {
      // capture all events (mouse-up is needed to prevent us stuck in moving map)
      if (event.type !== 'mouseup') event.stopPropagation();

      this.usePolygon = selectionType === SELECTION_TYPE.POLYGON;

      var redraw = false;
      var deactivate = false;

      var usePolygon = this.usePolygon,
          landPoints = this.landPoints,
          mousePoints = this.mousePoints;


      if (event.type === 'mousedown') {
        if (usePolygon && landPoints.length) {
          // if landPoints.length is zero we want to insert two points (so we let it run the else)
          // also don't insert if polygon is invalid
          if (this.landPoints.length < 3 || this.validPolygon) {
            landPoints.push(lngLat);
            mousePoints.push(this._getMousePosFromEvent(event));
          }
        } else {
          this.landPoints = [lngLat, lngLat];
          var m = this._getMousePosFromEvent(event);
          this.mousePoints = [m, m];
        }
        redraw = true;
      } else if (event.type === 'mousemove' && landPoints.length) {
        // update last point
        landPoints[landPoints.length - 1] = lngLat;
        mousePoints[mousePoints.length - 1] = this._getMousePosFromEvent(event);
        redraw = true;
      } else if (event.type === 'mouseup') {
        if (usePolygon) {
          // check to see if completed
          // TODO: Maybe double-click to finish?
          if (landPoints.length > 4 && (0, _distance2.default)(landPoints[0], landPoints[landPoints.length - 1]) < POLYGON_THRESHOLD && this.validPolygon) {
            this._selectPolygonObjects();
            this.reset();
            redraw = true;
            deactivate = true;
          }
        } else {
          this._selectRectangleObjects();
          this.reset();
          redraw = true;
          deactivate = true;
        }
      }

      return { redraw: redraw, deactivate: deactivate };
    }
  }, {
    key: 'reset',
    value: function reset() {
      this.landPoints = [];
      this.mousePoints = [];
    }
  }, {
    key: '_makeStartPointHighlight',
    value: function _makeStartPointHighlight(center) {
      var buffer = (0, _buffer2.default)((0, _helpers.point)(center), POLYGON_THRESHOLD / 4.0);
      return (0, _bboxPolygon2.default)((0, _bbox2.default)(buffer)).geometry.coordinates;
    }
  }, {
    key: 'render',
    value: function render() {
      var data = [];
      var dataPick = [];

      if (!this.usePolygon && this.landPoints.length === 2) {
        var _landPoints$ = _slicedToArray(this.landPoints[0], 2),
            x1 = _landPoints$[0],
            y1 = _landPoints$[1];

        var _landPoints$2 = _slicedToArray(this.landPoints[1], 2),
            x2 = _landPoints$2[0],
            y2 = _landPoints$2[1];

        var selPolygon = [[x1, y1], [x1, y2], [x2, y2], [x2, y1], [x1, y1]];
        data.push({
          polygon: selPolygon,
          lineColor: POLYGON_LINE_COLOR,
          fillColor: POLYGON_FILL_COLOR
        });
      } else if (this.usePolygon && this.landPoints.length) {
        data.push({
          polygon: this.landPoints,
          lineColor: POLYGON_LINE_COLOR,
          fillColor: POLYGON_FILL_COLOR
        });

        // Hack: use a polygon to hide the outside, because queryVisibleObjects()
        // does not support polygons
        if (this.landPoints.length >= 3) {
          var landPointsPoly = (0, _helpers.polygon)([[].concat(_toConsumableArray(this.landPoints), [this.landPoints[0]])]);
          var bigBuffer = (0, _buffer2.default)((0, _helpers.point)(this.landPoints[0]), EXPANSION_KM);
          var bigPolygon = void 0;
          try {
            // turfDifference throws an exception if the polygon
            // intersects with itself
            bigPolygon = (0, _difference2.default)(bigBuffer, landPointsPoly);
            dataPick.push({
              polygon: bigPolygon.geometry.coordinates,
              fillColor: [0, 0, 0, 1]
            });
            this.validPolygon = true;
          } catch (e) {
            // invalid selection polygon
            this.validPolygon = false;
          }
        }
      }

      if (this.landPoints.length) {
        // highlight start point
        data.push({
          polygon: this._makeStartPointHighlight(this.landPoints[0]),
          lineColor: [0, 0, 0, 0],
          fillColor: POLYGON_LINE_COLOR
        });
      }

      // Hack to make the PolygonLayer() stay active,
      // otherwise it takes 3 seconds (!) to init!
      // TODO: fix this
      data.push({ polygon: [[0, 0]] });
      dataPick.push({ polygon: [[0, 0]] });

      return [new _deck.PolygonLayer({
        id: LAYER_ID_VIEW,
        data: data,
        fp64: false,
        opacity: 1.0,
        pickable: false,
        lineWidthMinPixels: POLYGON_LINE_WIDTH,
        lineWidthMaxPixels: POLYGON_LINE_WIDTH,
        lineDashJustified: true,
        getLineDashArray: function getLineDashArray(x) {
          return POLYGON_DASHES;
        },
        coordinateSystem: _deck.COORDINATE_SYSTEM.LNGLAT_OFFSETS,
        coordinateOrigin: this.nebula.projector.lngLat,
        getPolygon: this._getPolygon
      }), new _deck.PolygonLayer({
        id: LAYER_ID_PICK,
        data: dataPick,
        fp64: false,
        opacity: 1.0,
        stroked: false,
        pickable: true,
        coordinateSystem: _deck.COORDINATE_SYSTEM.LNGLAT_OFFSETS,
        coordinateOrigin: this.nebula.projector.lngLat,
        getPolygon: this._getPolygon
      })];
    }
  }]);

  return DeckDrawer;
}();

exports.default = DeckDrawer;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9saWIvZGVjay1yZW5kZXJlci9kZWNrLWRyYXdlci5qcyJdLCJuYW1lcyI6WyJQT0xZR09OX0xJTkVfQ09MT1IiLCJQT0xZR09OX0ZJTExfQ09MT1IiLCJQT0xZR09OX0xJTkVfV0lEVEgiLCJQT0xZR09OX0RBU0hFUyIsIlBPTFlHT05fVEhSRVNIT0xEIiwiRVhQQU5TSU9OX0tNIiwiTEFZRVJfSURfVklFVyIsIkxBWUVSX0lEX1BJQ0siLCJTRUxFQ1RJT05fVFlQRSIsIk5PTkUiLCJSRUNUQU5HTEUiLCJQT0xZR09OIiwiRGVja0RyYXdlciIsIm5lYnVsYSIsIl9nZXRQb2x5Z29uIiwibyIsImNvb3Jkc1RvTG5nTGF0T2Zmc2V0IiwicHJvamVjdG9yIiwiQXJyYXkiLCJpc0FycmF5IiwicG9seWdvbiIsIm1hcCIsImEiLCJ1c2VQb2x5Z29uIiwibGFuZFBvaW50cyIsIm1vdXNlUG9pbnRzIiwiZGVja2dsIiwicHJvcHMiLCJsYXllcnMiLCJmaWx0ZXIiLCJsIiwibmVidWxhTGF5ZXIiLCJlbmFibGVTZWxlY3Rpb24iLCJpZCIsInBpY2tpbmdJbmZvcyIsIm9iamVjdHMiLCJsYXllciIsImluZGV4Iiwib2JqZWN0Iiwib3JpZ2luYWwiLCJkZWNrQ2FjaGUiLCJvcmlnaW5hbHMiLCJvblNlbGVjdGlvbiIsImFsbFgiLCJtb3VzZVBvaW50IiwiYWxsWSIsIngiLCJNYXRoIiwibWluIiwieSIsIm1heFgiLCJtYXgiLCJtYXhZIiwid2lkdGgiLCJoZWlnaHQiLCJsZW5ndGgiLCJ4MSIsInkxIiwieDIiLCJ5MiIsInF1ZXJ5VmlzaWJsZU9iamVjdHMiLCJhYnMiLCJsYXllcklkcyIsIl9nZXRMYXllcklkcyIsIl9zZWxlY3RGcm9tUGlja2luZ0luZm9zIiwiX2dldEJvdW5kaW5nQm94IiwiaXRlbSIsImV2ZW50Iiwib2Zmc2V0WCIsIm9mZnNldFkiLCJsbmdMYXQiLCJzZWxlY3Rpb25UeXBlIiwidHlwZSIsInN0b3BQcm9wYWdhdGlvbiIsInJlZHJhdyIsImRlYWN0aXZhdGUiLCJ2YWxpZFBvbHlnb24iLCJwdXNoIiwiX2dldE1vdXNlUG9zRnJvbUV2ZW50IiwibSIsIl9zZWxlY3RQb2x5Z29uT2JqZWN0cyIsInJlc2V0IiwiX3NlbGVjdFJlY3RhbmdsZU9iamVjdHMiLCJjZW50ZXIiLCJidWZmZXIiLCJnZW9tZXRyeSIsImNvb3JkaW5hdGVzIiwiZGF0YSIsImRhdGFQaWNrIiwic2VsUG9seWdvbiIsImxpbmVDb2xvciIsImZpbGxDb2xvciIsImxhbmRQb2ludHNQb2x5IiwiYmlnQnVmZmVyIiwiYmlnUG9seWdvbiIsImUiLCJfbWFrZVN0YXJ0UG9pbnRIaWdobGlnaHQiLCJmcDY0Iiwib3BhY2l0eSIsInBpY2thYmxlIiwibGluZVdpZHRoTWluUGl4ZWxzIiwibGluZVdpZHRoTWF4UGl4ZWxzIiwibGluZURhc2hKdXN0aWZpZWQiLCJnZXRMaW5lRGFzaEFycmF5IiwiY29vcmRpbmF0ZVN5c3RlbSIsIkxOR0xBVF9PRkZTRVRTIiwiY29vcmRpbmF0ZU9yaWdpbiIsImdldFBvbHlnb24iLCJzdHJva2VkIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7Ozs7Ozs7OztBQUVBLElBQU1BLHFCQUFxQixDQUFDLENBQUQsRUFBSSxHQUFKLEVBQVMsQ0FBVCxFQUFZLEdBQVosQ0FBM0I7QUFDQSxJQUFNQyxxQkFBcUIsQ0FBQyxHQUFELEVBQU0sR0FBTixFQUFXLEdBQVgsRUFBZ0IsRUFBaEIsQ0FBM0I7QUFDQSxJQUFNQyxxQkFBcUIsQ0FBM0I7QUFDQSxJQUFNQyxpQkFBaUIsQ0FBQyxFQUFELEVBQUssRUFBTCxDQUF2QjtBQUNBLElBQU1DLG9CQUFvQixJQUExQjtBQUNBLElBQU1DLGVBQWUsRUFBckI7QUFDQSxJQUFNQyxnQkFBZ0IsZ0JBQXRCO0FBQ0EsSUFBTUMsZ0JBQWdCLGdCQUF0Qjs7QUFFTyxJQUFNQywwQ0FBaUI7QUFDNUJDLFFBQU0sQ0FE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ZlQsa0JBQVUsSUFOSztBQU9mSywwQkFBa0Isd0JBQWtCQyxjQVByQjtBQVFmQywwQkFBa0IsS0FBSzdGLE1BQUwsQ0FBWUksU0FBWixDQUFzQnFELE1BUnpCO0FBU2ZxQyxvQkFBWSxLQUFLN0Y7QUFURixPQUFqQixDQWZLLENBQVA7QUEyQkQ7Ozs7OztrQkE1T2tCRixVIiwiZmlsZSI6ImRlY2stZHJhd2VyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQGZsb3dcbmltcG9ydCB7IFBvbHlnb25MYXllciwgQ09PUkRJTkFURV9TWVNURU0gfSBmcm9tICdkZWNrLmdsJztcbmltcG9ydCB7IHBvaW50LCBwb2x5Z29uIH0gZnJvbSAnQHR1cmYvaGVscGVycyc7XG5pbXBvcnQgdHVyZkJib3ggZnJvbSAnQHR1cmYvYmJveCc7XG5pbXBvcnQgdHVyZkJib3hQb2x5Z29uIGZyb20gJ0B0dXJmL2Jib3gtcG9seWdvbic7XG5pbXBvcnQgdHVyZkJ1ZmZlciBmcm9tICdAdHVyZi9idWZmZXInO1xuaW1wb3J0IHR1cmZEaWZmZXJlbmNlIGZyb20gJ0B0dXJmL2RpZmZlcmVuY2UnO1xuaW1wb3J0IHR1cmZEaXN0YW5jZSBmcm9tICdAdHVyZi9kaXN0YW5jZSc7XG5cbmNvbnN0IFBPTFlHT05fTElORV9DT0xPUiA9IFswLCAyNTUsIDAsIDI1NV07XG5jb25zdCBQT0xZR09OX0ZJTExfQ09MT1IgPSBbMjU1LCAyNTUsIDI1NSwgOTBdO1xuY29uc3QgUE9MWUdPTl9MSU5FX1dJRFRIID0gMjtcbmNvbnN0IFBPTFlHT05fREFTSEVTID0gWzIwLCAyMF07XG5jb25zdCBQT0xZR09OX1RIUkVTSE9MRCA9IDAuMDE7XG5jb25zdCBFWFBBTlNJT05fS00gPSAxMDtcbmNvbnN0IExBWUVSX0lEX1ZJRVcgPSAnRGVja0RyYXdlclZpZXcnO1xuY29uc3QgTEFZRVJfSURfUElDSyA9ICdEZWNrRHJhd2VyUGljayc7XG5cbmV4cG9ydCBjb25zdCBTRUxFQ1RJT05fVFlQRSA9IHtcbiAgTk9ORTogMCxcbiAgUkVDVEFOR0xFOiAxLFxuICBQT0xZR09OOiAyXG59O1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBEZWNrRHJhd2VyIHtcbiAgbmVidWxhOiBPYmplY3Q7XG4gIHVzZVBvbHlnb246IGJvb2xlYW47XG4gIHZhbGlkUG9seWdvbjogYm9vbGVhbjtcbiAgbGFuZFBvaW50czogW251bWJlciwgbnVtYmVyXVtdO1xuICBtb3VzZVBvaW50czogW251bWJlciwgbnVtYmVyXVtdO1xuXG4gIGNvbnN0cnVjdG9yKG5lYnVsYTogT2JqZWN0KSB7XG4gICAgdGhpcy5uZWJ1bGEgPSBuZWJ1bGE7XG4gICAgdGhpcy51c2VQb2x5Z29uID0gZmFsc2U7XG4gICAgdGhpcy5sYW5kUG9pbnRzID0gW107XG4gICAgdGhpcy5tb3VzZVBvaW50cyA9IFtdO1xuICB9XG5cbiAgX2dldExheWVySWRzKCkge1xuICAgIC8vIFRPRE86IHNvcnQgYnkgbW91c2UgcHJpb3JpdHlcbiAgICByZXR1cm4gdGhpcy5uZWJ1bGEuZGVja2dsLnByb3BzLmxheWVyc1xuICAgICAgLmZpbHRlcihsID0+IGwgJiYgbC5wcm9wcyAmJiBsLnByb3BzLm5lYnVsYUxheWVyICYmIGwucHJvcHMubmVidWxhTGF5ZXIuZW5hYmxlU2VsZWN0aW9uKVxuICAgICAgLm1hcChsID0+IGwuaWQpO1xuICB9XG5cbiAgX3NlbGVjdEZyb21QaWNraW5nSW5mb3MocGlja2luZ0luZm9zOiBPYmplY3RbXSkge1xuICAgIGNvbnN0IG9iamVjdHMgPSBwaWNraW5nSW5mb3MubWFwKFxuICAgICAgKHsgbGF5ZXIsIGluZGV4LCBvYmplY3QgfSkgPT5cbiAgICAgICAgb2JqZWN0Lm9yaWdpbmFsIHx8IGxheWVyLnByb3BzLm5lYnVsYUxheWVyLmRlY2tDYWNoZS5vcmlnaW5hbHNbaW5kZXhdXG4gICAgKTtcbiAgICB0aGlzLm5lYnVsYS5wcm9wcy5vblNlbGVjdGlvbihvYmplY3RzKTtcbiAgfVxuXG4gIF9nZXRCb3VuZGluZ0JveCgpOiBPYmplY3Qge1xuICAgIGNvbnN0IHsgbW91c2VQb2ludHMgfSA9IHRoaXM7XG4gICAgY29uc3QgYWxsWCA9IG1vdXNlUG9pbnRzLm1hcChtb3VzZVBvaW50ID0+IG1vdXNlUG9pbnRbMF0pO1xuICAgIGNvbnN0IGFsbFkgPSBtb3VzZVBvaW50cy5tYXAobW91c2VQb2ludCA9PiBtb3VzZVBvaW50WzFdKTtcbiAgICBjb25zdCB4ID0gTWF0aC5taW4oLi4uYWxsWCk7XG4gICAgY29uc3QgeSA9IE1hdGgubWluKC4uLmFsbFkpO1xuICAgIGNvbnN0IG1heFggPSBNYXRoLm1heCguLi5hbGxYKTtcbiAgICBjb25zdCBtYXhZID0gTWF0aC5tYXgoLi4uYWxsWSk7XG5cbiAgICByZXR1cm4geyB4LCB5LCB3aWR0aDogbWF4WCAtIHgsIGhlaWdodDogbWF4WSAtIHkgfTtcbiAgfVxuXG4gIF9zZWxlY3RSZWN0YW5nbGVPYmplY3RzKCkge1xuICAgIGlmICh0aGlzLmxhbmRQb2ludHMubGVuZ3RoICE9PSAyKSByZXR1cm47XG5cbiAgICBjb25zdCBbeDEsIHkxXSA9IHRoaXMubW91c2VQb2ludHNbMF07XG4gICAgY29uc3QgW3gyLCB5Ml0gPSB0aGlzLm1vdXNlUG9pbnRzWzFdO1xuICAgIGNvbnN0IHBpY2tpbmdJbmZvcyA9IHRoaXMubmVidWxhLmRlY2tnbC5xdWVyeVZpc2libGVPYmplY3RzKHtcbiAgICAgIHg6IE1hdGgubWluKHgxLCB4MiksXG4gICAgICB5OiBNYXRoLm1pbih5MSwgeTIpLFxuICAgICAgd2lkdGg6IE1hdGguYWJzKHgyIC0geDEpLFxuICAgICAgaGVpZ2h0OiBNYXRoLmFicyh5MiAtIHkxKSxcbiAgICAgIGxheWVySWRzOiB0aGlzLl9nZXRMYXllcklkcygpXG4gICAgfSk7XG5cbiAgICB0aGlzLl9zZWxlY3RGcm9tUGlja2luZ0luZm9zKHBpY2tpbmdJbmZvcyk7XG4gIH1cblxuICBfc2VsZWN0UG9seWdvbk9iamVjdHMoKSB7XG4gICAgY29uc3QgcGlja2luZ0luZm9zID0gdGhpcy5uZWJ1bGEuZGVja2dsLnF1ZXJ5VmlzaWJsZU9iamVjdHMoe1xuICAgICAgLi4udGhpcy5fZ2V0Qm91bmRpbmdCb3goKSxcbiAgICAgIGxheWVySWRzOiBbTEFZRVJfSURfUElDSywgLi4udGhpcy5fZ2V0TGF5ZXJJZHMoKV1cbiAgICB9KTtcblxuICAgIHRoaXMuX3NlbGVjdEZyb21QaWNraW5nSW5mb3MocGlja2luZ0luZm9zLmZpbHRlcihpdGVtID0+IGl0ZW0ubGF5ZXIuaWQgIT09IExBWUVSX0lEX1BJQ0spKTtcbiAgfVxuXG4gIF9nZXRNb3VzZVBvc0Zyb21FdmVudChldmVudDogT2JqZWN0KTogW251bWJlciwgbnVtYmVyXSB7XG4gICAgY29uc3QgeyBvZmZzZXRYLCBvZmZzZXRZIH0gPSBldmVudDtcbiAgICByZXR1cm4gW29mZnNldFgsIG9mZnNldFldO1xuICB9XG5cbiAgaGFuZGxlRXZlbnQoXG4gICAgZXZlbnQ6IE9iamVjdCxcbiAgICBsbmdMYXQ6IFtudW1iZXIsIG51bWJlcl0sXG4gICAgc2VsZWN0aW9uVHlwZTogbnVtYmVyXG4gICk6IHsgcmVkcmF3OiBib29sZWFuLCBkZWFjdGl2YXRlOiBib29sZWFuIH0ge1xuICAgIC8vIGNhcHR1cmUgYWxsIGV2ZW50cyAobW91c2UtdXAgaXMgbmVlZGVkIHRvIHByZXZlbnQgdXMgc3R1Y2sgaW4gbW92aW5nIG1hcClcbiAgICBpZiAoZXZlbnQudHlwZSAhPT0gJ21vdXNldXAnKSBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcblxuICAgIHRoaXMudXNlUG9seWdvbiA9IHNlbGVjdGlvblR5cGUgPT09IFNFTEVDVElPTl9UWVBFLlBPTFlHT047XG5cbiAgICBsZXQgcmVkcmF3ID0gZmFsc2U7XG4gICAgbGV0IGRlYWN0aXZhdGUgPSBmYWxzZTtcblxuICAgIGNvbnN0IHsgdXNlUG9seWdvbiwgbGFuZFBvaW50cywgbW91c2VQb2ludHMgfSA9IHRoaXM7XG5cbiAgICBpZiAoZXZlbnQudHlwZSA9PT0gJ21vdXNlZG93bicpIHtcbiAgICAgIGlmICh1c2VQb2x5Z29uICYmIGxhbmRQb2ludHMubGVuZ3RoKSB7XG4gICAgICAgIC8vIGlmIGxhbmRQb2ludHMubGVuZ3RoIGlzIHplcm8gd2Ugd2FudCB0byBpbnNlcnQgdHdvIHBvaW50cyAoc28gd2UgbGV0IGl0IHJ1biB0aGUgZWxzZSlcbiAgICAgICAgLy8gYWxzbyBkb24ndCBpbnNlcnQgaWYgcG9seWdvbiBpcyBpbnZhbGlkXG4gICAgICAgIGlmICh0aGlzLmxhbmRQb2ludHMubGVuZ3RoIDwgMyB8fCB0aGlzLnZhbGlkUG9seWdvbikge1xuICAgICAgICAgIGxhbmRQb2ludHMucHVzaChsbmdMYXQpO1xuICAgICAgICAgIG1vdXNlUG9pbnRzLnB1c2godGhpcy5fZ2V0TW91c2VQb3NGcm9tRXZlbnQoZXZlbnQpKTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5sYW5kUG9pbnRzID0gW2xuZ0xhdCwgbG5nTGF0XTtcbiAgICAgICAgY29uc3QgbSA9IHRoaXMuX2dldE1vdXNlUG9zRnJvbUV2ZW50KGV2ZW50KTtcbiAgICAgICAgdGhpcy5tb3VzZVBvaW50cyA9IFttLCBtXTtcbiAgICAgIH1cbiAgICAgIHJlZHJhdyA9IHRydWU7XG4gICAgfSBlbHNlIGlmIChldmVudC50eXBlID09PSAnbW91c2Vtb3ZlJyAmJiBsYW5kUG9pbnRzLmxlbmd0aCkge1xuICAgICAgLy8gdXBkYXRlIGxhc3QgcG9pbnRcbiAgICAgIGxhbmRQb2ludHNbbGFuZFBvaW50cy5sZW5ndGggLSAxXSA9IGxuZ0xhdDtcbiAgICAgIG1vdXNlUG9pbnRzW21vdXNlUG9pbnRzLmxlbmd0aCAtIDFdID0gdGhpcy5fZ2V0TW91c2VQb3NGcm9tRXZlbnQoZXZlbnQpO1xuICAgICAgcmVkcmF3ID0gdHJ1ZTtcbiAgICB9IGVsc2UgaWYgKGV2ZW50LnR5cGUgPT09ICdtb3VzZXVwJykge1xuICAgICAgaWYgKHVzZVBvbHlnb24pIHtcbiAgICAgICAgLy8gY2hlY2sgdG8gc2VlIGlmIGNvbXBsZXRlZFxuICAgICAgICAvLyBUT0RPOiBNYXliZSBkb3VibGUtY2xpY2sgdG8gZmluaXNoP1xuICAgICAgICBpZiAoXG4gICAgICAgICAgbGFuZFBvaW50cy5sZW5ndGggPiA0ICYmXG4gICAgICAgICAgdHVyZkRpc3RhbmNlKGxhbmRQb2ludHNbMF0sIGxhbmRQb2ludHNbbGFuZFBvaW50cy5sZW5ndGggLSAxXSkgPCBQT0xZR09OX1RIUkVTSE9MRCAmJlxuICAgICAgICAgIHRoaXMudmFsaWRQb2x5Z29uXG4gICAgICAgICkge1xuICAgICAgICAgIHRoaXMuX3NlbGVjdFBvbHlnb25PYmplY3RzKCk7XG4gICAgICAgICAgdGhpcy5yZXNldCgpO1xuICAgICAgICAgIHJlZHJhdyA9IHRydWU7XG4gICAgICAgICAgZGVhY3RpdmF0ZSA9IHRydWU7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuX3NlbGVjdFJlY3RhbmdsZU9iamVjdHMoKTtcbiAgICAgICAgdGhpcy5yZXNldCgpO1xuICAgICAgICByZWRyYXcgPSB0cnVlO1xuICAgICAgICBkZWFjdGl2YXRlID0gdHJ1ZTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4geyByZWRyYXcsIGRlYWN0aXZhdGUgfTtcbiAgfVxuXG4gIHJlc2V0KCkge1xuICAgIHRoaXMubGFuZFBvaW50cyA9IFtdO1xuICAgIHRoaXMubW91c2VQb2ludHMgPSBbXTtcbiAgfVxuXG4gIF9tYWtlU3RhcnRQb2ludEhpZ2hsaWdodChjZW50ZXI6IFtudW1iZXIsIG51bWJlcl0pOiBudW1iZXJbXSB7XG4gICAgY29uc3QgYnVmZmVyID0gdHVyZkJ1ZmZlcihwb2ludChjZW50ZXIpLCBQT0xZR09OX1RIUkVTSE9MRCAvIDQuMCk7XG4gICAgcmV0dXJuIHR1cmZCYm94UG9seWdvbih0dXJmQmJveChidWZmZXIpKS5nZW9tZXRyeS5jb29yZGluYXRlcztcbiAgfVxuXG4gIF9nZXRQb2x5Z29uID0gKG86IE9iamVjdCk6IGFueSA9PiB7XG4gICAgY29uc3QgeyBjb29yZHNUb0xuZ0xhdE9mZnNldCB9ID0gdGhpcy5uZWJ1bGEucHJvamVjdG9yO1xuXG4gICAgaWYgKEFycmF5LmlzQXJyYXkoby5wb2x5Z29uWzBdWzBdKSkge1xuICAgICAgLy8gY29tcGxleCBwb2x5Z29uIHdpdGggaG9sZXNcbiAgICAgIHJldHVybiBvLnBvbHlnb24ubWFwKGEgPT4gYS5tYXAoY29vcmRzVG9MbmdMYXRPZmZzZXQpKTtcbiAgICB9XG5cbiAgICAvLyBzaW1wbGUgcG9seWdvblxuICAgIHJldHVybiBvLnBvbHlnb24ubWFwKGNvb3Jkc1RvTG5nTGF0T2Zmc2V0KTtcbiAgfTtcblxuICByZW5kZXIoKSB7XG4gICAgY29uc3QgZGF0YSA9IFtdO1xuICAgIGNvbnN0IGRhdGFQaWNrID0gW107XG5cbiAgICBpZiAoIXRoaXMudXNlUG9seWdvbiAmJiB0aGlzLmxhbmRQb2ludHMubGVuZ3RoID09PSAyKSB7XG4gICAgICBjb25zdCBbeDEsIHkxXSA9IHRoaXMubGFuZFBvaW50c1swXTtcbiAgICAgIGNvbnN0IFt4MiwgeTJdID0gdGhpcy5sYW5kUG9pbnRzWzFdO1xuICAgICAgY29uc3Qgc2VsUG9seWdvbiA9IFtbeDEsIHkxXSwgW3gxLCB5Ml0sIFt4MiwgeTJdLCBbeDIsIHkxXSwgW3gxLCB5MV1dO1xuICAgICAgZGF0YS5wdXNoKHtcbiAgICAgICAgcG9seWdvbjogc2VsUG9seWdvbixcbiAgICAgICAgbGluZUNvbG9yOiBQT0xZR09OX0xJTkVfQ09MT1IsXG4gICAgICAgIGZpbGxDb2xvcjogUE9MWUdPTl9GSUxMX0NPTE9SXG4gICAgICB9KTtcbiAgICB9IGVsc2UgaWYgKHRoaXMudXNlUG9seWdvbiAmJiB0aGlzLmxhbmRQb2ludHMubGVuZ3RoKSB7XG4gICAgICBkYXRhLnB1c2goe1xuICAgICAgICBwb2x5Z29uOiB0aGlzLmxhbmRQb2ludHMsXG4gICAgICAgIGxpbmVDb2xvcjogUE9MWUdPTl9MSU5FX0NPTE9SLFxuICAgICAgICBmaWxsQ29sb3I6IFBPTFlHT05fRklMTF9DT0xPUlxuICAgICAgfSk7XG5cbiAgICAgIC8vIEhhY2s6IHVzZSBhIHBvbHlnb24gdG8gaGlkZSB0aGUgb3V0c2lkZSwgYmVjYXVzZSBxdWVyeVZpc2libGVPYmplY3RzKClcbiAgICAgIC8vIGRvZXMgbm90IHN1cHBvcnQgcG9seWdvbnNcbiAgICAgIGlmICh0aGlzLmxhbmRQb2ludHMubGVuZ3RoID49IDMpIHtcbiAgICAgICAgY29uc3QgbGFuZFBvaW50c1BvbHkgPSBwb2x5Z29uKFtbLi4udGhpcy5sYW5kUG9pbnRzLCB0aGlzLmxhbmRQb2ludHNbMF1dXSk7XG4gICAgICAgIGNvbnN0IGJpZ0J1ZmZlciA9IHR1cmZCdWZmZXIocG9pbnQodGhpcy5sYW5kUG9pbnRzWzBdKSwgRVhQQU5TSU9OX0tNKTtcbiAgICAgICAgbGV0IGJpZ1BvbHlnb247XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgLy8gdHVyZkRpZmZlcmVuY2UgdGhyb3dzIGFuIGV4Y2VwdGlvbiBpZiB0aGUgcG9seWdvblxuICAgICAgICAgIC8vIGludGVyc2VjdHMgd2l0aCBpdHNlbGZcbiAgICAgICAgICBiaWdQb2x5Z29uID0gdHVyZkRpZmZlcmVuY2UoYmlnQnVmZmVyLCBsYW5kUG9pbnRzUG9seSk7XG4gICAgICAgICAgZGF0YVBpY2sucHVzaCh7XG4gICAgICAgICAgICBwb2x5Z29uOiBiaWdQb2x5Z29uLmdlb21ldHJ5LmNvb3JkaW5hdGVzLFxuICAgICAgICAgICAgZmlsbENvbG9yOiBbMCwgMCwgMCwgMV1cbiAgICAgICAgICB9KTtcbiAgICAgICAgICB0aGlzLnZhbGlkUG9seWdvbiA9IHRydWU7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAvLyBpbnZhbGlkIHNlbGVjdGlvbiBwb2x5Z29uXG4gICAgICAgICAgdGhpcy52YWxpZFBvbHlnb24gPSBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIGlmICh0aGlzLmxhbmRQb2ludHMubGVuZ3RoKSB7XG4gICAgICAvLyBoaWdobGlnaHQgc3RhcnQgcG9pbnRcbiAgICAgIGRhdGEucHVzaCh7XG4gICAgICAgIHBvbHlnb246IHRoaXMuX21ha2VTdGFydFBvaW50SGlnaGxpZ2h0KHRoaXMubGFuZFBvaW50c1swXSksXG4gICAgICAgIGxpbmVDb2xvcjogWzAsIDAsIDAsIDBdLFxuICAgICAgICBmaWxsQ29sb3I6IFBPTFlHT05fTElORV9DT0xPUlxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8gSGFjayB0byBtYWtlIHRoZSBQb2x5Z29uTGF5ZXIoKSBzdGF5IGFjdGl2ZSxcbiAgICAvLyBvdGhlcndpc2UgaXQgdGFrZXMgMyBzZWNvbmRzICghKSB0byBpbml0IVxuICAgIC8vIFRPRE86IGZpeCB0aGlzXG4gICAgZGF0YS5wdXNoKHsgcG9seWdvbjogW1swLCAwXV0gfSk7XG4gICAgZGF0YVBpY2sucHVzaCh7IHBvbHlnb246IFtbMCwgMF1dIH0pO1xuXG4gICAgcmV0dXJuIFtcbiAgICAgIG5ldyBQb2x5Z29uTGF5ZXIoe1xuICAgICAgICBpZDogTEFZRVJfSURfVklFVyxcbiAgICAgICAgZGF0YSxcbiAgICAgICAgZnA2NDogZmFsc2UsXG4gICAgICAgIG9wYWNpdHk6IDEuMCxcbiAgICAgICAgcGlja2FibGU6IGZhbHNlLFxuICAgICAgICBsaW5lV2lkdGhNaW5QaXhlbHM6IFBPTFlHT05fTElORV9XSURUSCxcbiAgICAgICAgbGluZVdpZHRoTWF4UGl4ZWxzOiBQT0xZR09OX0xJTkVfV0lEVEgsXG4gICAgICAgIGxpbmVEYXNoSnVzdGlmaWVkOiB0cnVlLFxuICAgICAgICBnZXRMaW5lRGFzaEFycmF5OiB4ID0+IFBPTFlHT05fREFTSEVTLFxuICAgICAgICBjb29yZGluYXRlU3lzdGVtOiBDT09SRElOQVRFX1NZU1RFTS5MTkdMQVRfT0ZGU0VUUyxcbiAgICAgICAgY29vcmRpbmF0ZU9yaWdpbjogdGhpcy5uZWJ1bGEucHJvamVjdG9yLmxuZ0xhdCxcbiAgICAgICAgZ2V0UG9seWdvbjogdGhpcy5fZ2V0UG9seWdvblxuICAgICAgfSksXG4gICAgICBuZXcgUG9seWdvbkxheWVyKHtcbiAgICAgICAgaWQ6IExBWUVSX0lEX1BJQ0ssXG4gICAgICAgIGRhdGE6IGRhdGFQaWNrLFxuICAgICAgICBmcDY0OiBmYWxzZSxcbiAgICAgICAgb3BhY2l0eTogMS4wLFxuICAgICAgICBzdHJva2VkOiBmYWxzZSxcbiAgICAgICAgcGlja2FibGU6IHRydWUsXG4gICAgICAgIGNvb3JkaW5hdGVTeXN0ZW06IENPT1JESU5BVEVfU1lTVEVNLkxOR0xBVF9PRkZTRVRTLFxuICAgICAgICBjb29yZGluYXRlT3JpZ2luOiB0aGlzLm5lYnVsYS5wcm9qZWN0b3IubG5nTGF0LFxuICAgICAgICBnZXRQb2x5Z29uOiB0aGlzLl9nZXRQb2x5Z29uXG4gICAgICB9KVxuICAgIF07XG4gIH1cbn1cbiJdfQ==