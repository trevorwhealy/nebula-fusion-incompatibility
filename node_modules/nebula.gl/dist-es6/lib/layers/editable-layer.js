'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; };

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

var _deck = require('deck.gl');

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _possibleConstructorReturn(self, call) { if (!self) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return call && (typeof call === "object" || typeof call === "function") ? call : self; }

function _inherits(subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function, not " + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass; }
/* eslint-env browser */

// Minimum number of pixels the pointer must move from the original pointer down to be considered dragging
var MINIMUM_POINTER_MOVE_THRESHOLD_PIXELS = 7;

var EditableLayer = function (_CompositeLayer) {
  _inherits(EditableLayer, _CompositeLayer);

  function EditableLayer() {
    _classCallCheck(this, EditableLayer);

    return _possibleConstructorReturn(this, (EditableLayer.__proto__ || Object.getPrototypeOf(EditableLayer)).apply(this, arguments));
  }

  _createClass(EditableLayer, [{
    key: 'onClick',

    // Overridable interaction event handlers
    value: function onClick(_ref) {
      // default implementation - do nothing

      var picks = _ref.picks,
          screenCoords = _ref.screenCoords,
          groundCoords = _ref.groundCoords;
    }
  }, {
    key: 'onStartDragging',
    value: function onStartDragging(_ref2) {
      // default implementation - do nothing

      var picks = _ref2.picks,
          screenCoords = _ref2.screenCoords,
          groundCoords = _ref2.groundCoords,
          dragStartScreenCoords = _ref2.dragStartScreenCoords,
          dragStartGroundCoords = _ref2.dragStartGroundCoords;
    }
  }, {
    key: 'onDragging',
    value: function onDragging(_ref3) {
      // default implementation - do nothing

      var picks = _ref3.picks,
          screenCoords = _ref3.screenCoords,
          groundCoords = _ref3.groundCoords,
          dragStartScreenCoords = _ref3.dragStartScreenCoords,
          dragStartGroundCoords = _ref3.dragStartGroundCoords;
    }
  }, {
    key: 'onStopDragging',
    value: function onStopDragging(_ref4) {
      // default implementation - do nothing

      var picks = _ref4.picks,
          screenCoords = _ref4.screenCoords,
          groundCoords = _ref4.groundCoords,
          dragStartScreenCoords = _ref4.dragStartScreenCoords,
          dragStartGroundCoords = _ref4.dragStartGroundCoords;
    }
  }, {
    key: 'onPointerMove',
    value: function onPointerMove(_ref5) {
      var screenCoords = _ref5.screenCoords,
          groundCoords = _ref5.groundCoords,
          isDragging = _ref5.isDragging,
          sourceEvent = _ref5.sourceEvent;
    }
    // default implementation - do nothing


    // TODO: implement onCancelDragging (e.g. drag off screen)

  }, {
    key: 'initializeState',
    value: function initializeState() {
      this.setState({
        _editableLayerState: {
          // Pointer event handlers
          pointerHandlers: null,
          // Picked objects at the time the pointer went down
          pointerDownPicks: null,
          // Screen coordinates where the pointer went down
          pointerDownScreenCoords: null,
          // Ground coordinates where the pointer went down
          pointerDownGroundCoords: null,
          // Is the pointer dragging (pointer down + moved at least MINIMUM_POINTER_MOVE_THRESHOLD_PIXELS)
          isDragging: false
        }
      });
    }
  }, {
    key: 'finalizeState',
    value: function finalizeState() {
      this._removePointerHandlers();
    }
  }, {
    key: 'updateState',
    value: function updateState(_ref6) {
      var props = _ref6.props,
          changeFlags = _ref6.changeFlags;

      // unsubscribe previous layer instance's handlers
      this._removePointerHandlers();
      this._addPointerHandlers();
    }
  }, {
    key: '_removePointerHandlers',
    value: function _removePointerHandlers() {
      if (this.state._editableLayerState.pointerHandlers) {
        this.context.gl.canvas.removeEventListener('pointermove', this.state._editableLayerState.pointerHandlers.onPointerMove);
        this.context.gl.canvas.removeEventListener('pointerdown', this.state._editableLayerState.pointerHandlers.onPointerDown);
        this.context.gl.canvas.removeEventListener('pointerup', this.state._editableLayerState.pointerHandlers.onPointerUp);
      }
      this.state._editableLayerState.pointerHandlers = null;
    }
  }, {
    key: '_addPointerHandlers',
    value: function _addPointerHandlers() {
      this.state._editableLayerState.pointerHandlers = {
        onPointerMove: this._onPointerMove.bind(this),
        onPointerDown: this._onPointerDown.bind(this),
        onPointerUp: this._onPointerUp.bind(this)
      };

      this.context.gl.canvas.addEventListener('pointermove', this.state._editableLayerState.pointerHandlers.onPointerMove);
      this.context.gl.canvas.addEventListener('pointerdown', this.state._editableLayerState.pointerHandlers.onPointerDown);
      this.context.gl.canvas.addEventListener('pointerup', this.state._editableLayerState.pointerHandlers.onPointerUp);
    }
  }, {
    key: '_onPointerDown',
    value: function _onPointerDown(event) {
      var screenCoords = this.getScreenCoords(event);
      var groundCoords = this.getGroundCoords(screenCoords);

      var picks = this.context.layerManager.pickObject({
        x: screenCoords[0],
        y: screenCoords[1],
        mode: 'query',
        layers: [this.props.id],
        radius: 10,
        viewports: [this.context.viewport]
      });

      this.setState({
        _editableLayerState: _extends({}, this.state._editableLayerState, {
          pointerDownScreenCoords: screenCoords,
          pointerDownGroundCoords: groundCoords,
          pointerDownPicks: picks,
          isDragging: false
        })
      });
    }
  }, {
    key: '_onPointerMove',
    value: function _onPointerMove(event) {
      var screenCoords = this.getScreenCoords(event);
      var groundCoords = this.getGroundCoords(screenCoords);

      var _state$_editableLayer = this.state._editableLayerState,
          pointerDownPicks = _state$_editableLayer.pointerDownPicks,
          pointerDownScreenCoords = _state$_editableLayer.pointerDownScreenCoords,
          pointerDownGroundCoords = _state$_editableLayer.pointerDownGroundCoords;
      var isDragging = this.state._editableLayerState.isDragging;


      if (pointerDownPicks && pointerDownPicks.length > 0) {
        // Pointer went down on something and is moving

        // Did it move enough to consider it a drag
        if (!isDragging && this.movedEnoughForDrag(pointerDownScreenCoords, screenCoords)) {
          // OK, this is considered dragging

          // Fire the start dragging event
          this.onStartDragging({
            picks: pointerDownPicks,
            screenCoords: screenCoords,
            groundCoords: groundCoords,
            dragStartScreenCoords: pointerDownScreenCoords,
            dragStartGroundCoords: pointerDownGroundCoords
          });

          isDragging = true;
          this.setState({
            _editableLayerState: _extends({}, this.state._editableLayerState, {
              isDragging: isDragging
            })
          });
        }
      }

      this.onPointerMove({
        screenCoords: screenCoords,
        groundCoords: groundCoords,
        isDragging: isDragging,
        pointerDownPicks: pointerDownPicks,
        sourceEvent: event
      });

      if (isDragging) {
        this.onDragging({
          picks: pointerDownPicks,
          screenCoords: screenCoords,
          groundCoords: groundCoords,
          dragStartScreenCoords: pointerDownScreenCoords,
          dragStartGroundCoords: pointerDownGroundCoords
        });
      }
    }
  }, {
    key: '_onPointerUp',
    value: function _onPointerUp(event) {
      var screenCoords = this.getScreenCoords(event);
      var groundCoords = this.getGroundCoords(screenCoords);

      var _state$_editableLayer2 = this.state._editableLayerState,
          pointerDownPicks = _state$_editableLayer2.pointerDownPicks,
          pointerDownScreenCoords = _state$_editableLayer2.pointerDownScreenCoords,
          pointerDownGroundCoords = _state$_editableLayer2.pointerDownGroundCoords,
          isDragging = _state$_editableLayer2.isDragging;


      if (!pointerDownScreenCoords) {
        // This is a pointer up without a pointer down (e.g. user pointer downed elsewhere), so ignore
        return;
      }

      if (isDragging) {
        this.onStopDragging({
          picks: pointerDownPicks,
          screenCoords: screenCoords,
          groundCoords: groundCoords,
          dragStartScreenCoords: pointerDownScreenCoords,
          dragStartGroundCoords: pointerDownGroundCoords
        });
      } else if (!this.movedEnoughForDrag(pointerDownScreenCoords, screenCoords)) {
        this.onClick({
          picks: pointerDownPicks,
          screenCoords: screenCoords,
          groundCoords: groundCoords
        });
      }

      this.setState({
        _editableLayerState: _extends({}, this.state._editableLayerState, {
          pointerDownScreenCoords: null,
          pointerDownGroundCoords: null,
          pointerDownPicks: null,
          isDragging: false
        })
      });
    }
  }, {
    key: 'getScreenCoords',
    value: function getScreenCoords(pointerEvent) {
      return [pointerEvent.clientX - this.context.gl.canvas.getBoundingClientRect().x, pointerEvent.clientY - this.context.gl.canvas.getBoundingClientRect().y];
    }
  }, {
    key: 'getGroundCoords',
    value: function getGroundCoords(screenCoords) {
      return this.context.viewport.unproject([screenCoords[0], screenCoords[1]]);
    }
  }, {
    key: 'movedEnoughForDrag',
    value: function movedEnoughForDrag(screenCoords1, screenCoords2) {
      return Math.abs(screenCoords1[0] - screenCoords2[0]) > MINIMUM_POINTER_MOVE_THRESHOLD_PIXELS || Math.abs(screenCoords1[1] - screenCoords2[1]) > MINIMUM_POINTER_MOVE_THRESHOLD_PIXELS;
    }
  }]);

  return EditableLayer;
}(_deck.CompositeLayer);

exports.default = EditableLayer;


EditableLayer.layerName = 'EditableLayer';
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9saWIvbGF5ZXJzL2VkaXRhYmxlLWxheWVyLmpzIl0sIm5hbWVzIjpbIk1JTklNVU1fUE9JTlRFUl9NT1ZFX1RIUkVTSE9MRF9QSVhFTFMiLCJFZGl0YWJsZUxheWVyIiwicGlja3MiLCJzY3JlZW5Db29yZHMiLCJncm91bmRDb29yZHMiLCJkcmFnU3RhcnRTY3JlZW5Db29yZHMiLCJkcmFnU3RhcnRHcm91bmRDb29yZHMiLCJpc0RyYWdnaW5nIiwic291cmNlRXZlbnQiLCJzZXRTdGF0ZSIsIl9lZGl0YWJsZUxheWVyU3RhdGUiLCJwb2ludGVySGFuZGxlcnMiLCJwb2ludGVyRG93blBpY2tzIiwicG9pbnRlckRvd25TY3JlZW5Db29yZHMiLCJwb2ludGVyRG93bkdyb3VuZENvb3JkcyIsIl9yZW1vdmVQb2ludGVySGFuZGxlcnMiLCJwcm9wcyIsImNoYW5nZUZsYWdzIiwiX2FkZFBvaW50ZXJIYW5kbGVycyIsInN0YXRlIiwiY29udGV4dCIsImdsIiwiY2FudmFzIiwicmVtb3ZlRXZlbnRMaXN0ZW5lciIsIm9uUG9pbnRlck1vdmUiLCJvblBvaW50ZXJEb3duIiwib25Qb2ludGVyVXAiLCJfb25Qb2ludGVyTW92ZSIsImJpbmQiLCJfb25Qb2ludGVyRG93biIsIl9vblBvaW50ZXJVcCIsImFkZEV2ZW50TGlzdGVuZXIiLCJldmVudCIsImdldFNjcmVlbkNvb3JkcyIsImdldEdyb3VuZENvb3JkcyIsImxheWVyTWFuYWdlciIsInBpY2tPYmplY3QiLCJ4IiwieSIsIm1vZGUiLCJsYXllcnMiLCJpZCIsInJhZGl1cyIsInZpZXdwb3J0cyIsInZpZXdwb3J0IiwibGVuZ3RoIiwibW92ZWRFbm91Z2hGb3JEcmFnIiwib25TdGFydERyYWdnaW5nIiwib25EcmFnZ2luZyIsIm9uU3RvcERyYWdnaW5nIiwib25DbGljayIsInBvaW50ZXJFdmVudCIsImNsaWVudFgiLCJnZXRCb3VuZGluZ0NsaWVudFJlY3QiLCJjbGllbnRZIiwidW5wcm9q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RUYsNEJBQWtCLElBSnBCO0FBS0VMLHNCQUFZO0FBTGQ7QUFEWSxPQUFkO0FBU0Q7OztvQ0FFZTRDLFksRUFBc0I7QUFDcEMsYUFBTyxDQUNMQSxhQUFhQyxPQUFiLEdBQXVCLEtBQUtoQyxPQUFMLENBQWFDLEVBQWIsQ0FBZ0JDLE1BQWhCLENBQXVCK0IscUJBQXZCLEdBQStDaEIsQ0FEakUsRUFFTGMsYUFBYUcsT0FBYixHQUF1QixLQUFLbEMsT0FBTCxDQUFhQyxFQUFiLENBQWdCQyxNQUFoQixDQUF1QitCLHFCQUF2QixHQUErQ2YsQ0FGakUsQ0FBUDtBQUlEOzs7b0NBRWVuQyxZLEVBQXdCO0FBQ3RDLGFBQU8sS0FBS2lCLE9BQUwsQ0FBYXdCLFFBQWIsQ0FBc0JXLFNBQXRCLENBQWdDLENBQUNwRCxhQUFhLENBQWIsQ0FBRCxFQUFrQkEsYUFBYSxDQUFiLENBQWxCLENBQWhDLENBQVA7QUFDRDs7O3VDQUVrQnFELGEsRUFBeUJDLGEsRUFBeUI7QUFDbkUsYUFDRUMsS0FBS0MsR0FBTCxDQUFTSCxjQUFjLENBQWQsSUFBbUJDLGNBQWMsQ0FBZCxDQUE1QixJQUFnRHpELHFDQUFoRCxJQUNBMEQsS0FBS0MsR0FBTCxDQUFTSCxjQUFjLENBQWQsSUFBbUJDLGNBQWMsQ0FBZCxDQUE1QixJQUFnRHpELHFDQUZsRDtBQUlEOzs7Ozs7a0JBeFBrQkMsYTs7O0FBMlByQkEsY0FBYzJELFNBQWQsR0FBMEIsZUFBMUIiLCJmaWxlIjoiZWRpdGFibGUtbGF5ZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBAZmxvd1xuLyogZXNsaW50LWVudiBicm93c2VyICovXG5cbmltcG9ydCB7IENvbXBvc2l0ZUxheWVyIH0gZnJvbSAnZGVjay5nbCc7XG5cbi8vIE1pbmltdW0gbnVtYmVyIG9mIHBpeGVscyB0aGUgcG9pbnRlciBtdXN0IG1vdmUgZnJvbSB0aGUgb3JpZ2luYWwgcG9pbnRlciBkb3duIHRvIGJlIGNvbnNpZGVyZWQgZHJhZ2dpbmdcbmNvbnN0IE1JTklNVU1fUE9JTlRFUl9NT1ZFX1RIUkVTSE9MRF9QSVhFTFMgPSA3O1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBFZGl0YWJsZUxheWVyIGV4dGVuZHMgQ29tcG9zaXRlTGF5ZXIge1xuICAvLyBPdmVycmlkYWJsZSBpbnRlcmFjdGlvbiBldmVudCBoYW5kbGVyc1xuICBvbkNsaWNrKHsgcGlja3MsIHNjcmVlbkNvb3JkcywgZ3JvdW5kQ29vcmRzIH06IE9iamVjdCkge1xuICAgIC8vIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gLSBkbyBub3RoaW5nXG4gIH1cblxuICBvblN0YXJ0RHJhZ2dpbmcoe1xuICAgIHBpY2tzLFxuICAgIHNjcmVlbkNvb3JkcyxcbiAgICBncm91bmRDb29yZHMsXG4gICAgZHJhZ1N0YXJ0U2NyZWVuQ29vcmRzLFxuICAgIGRyYWdTdGFydEdyb3VuZENvb3Jkc1xuICB9OiBPYmplY3QpIHtcbiAgICAvLyBkZWZhdWx0IGltcGxlbWVudGF0aW9uIC0gZG8gbm90aGluZ1xuICB9XG5cbiAgb25EcmFnZ2luZyh7XG4gICAgcGlja3MsXG4gICAgc2NyZWVuQ29vcmRzLFxuICAgIGdyb3VuZENvb3JkcyxcbiAgICBkcmFnU3RhcnRTY3JlZW5Db29yZHMsXG4gICAgZHJhZ1N0YXJ0R3JvdW5kQ29vcmRzXG4gIH06IE9iamVjdCkge1xuICAgIC8vIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gLSBkbyBub3RoaW5nXG4gIH1cblxuICBvblN0b3BEcmFnZ2luZyh7XG4gICAgcGlja3MsXG4gICAgc2NyZWVuQ29vcmRzLFxuICAgIGdyb3VuZENvb3JkcyxcbiAgICBkcmFnU3RhcnRTY3JlZW5Db29yZHMsXG4gICAgZHJhZ1N0YXJ0R3JvdW5kQ29vcmRzXG4gIH06IE9iamVjdCkge1xuICAgIC8vIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gLSBkbyBub3RoaW5nXG4gIH1cblxuICBvblBvaW50ZXJNb3ZlKHsgc2NyZWVuQ29vcmRzLCBncm91bmRDb29yZHMsIGlzRHJhZ2dpbmcsIHNvdXJjZUV2ZW50IH06IE9iamVjdCkge1xuICAgIC8vIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gLSBkbyBub3RoaW5nXG4gIH1cblxuICAvLyBUT0RPOiBpbXBsZW1lbnQgb25DYW5jZWxEcmFnZ2luZyAoZS5nLiBkcmFnIG9mZiBzY3JlZW4pXG5cbiAgaW5pdGlhbGl6ZVN0YXRlKCkge1xuICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgX2VkaXRhYmxlTGF5ZXJTdGF0ZToge1xuICAgICAgICAvLyBQb2ludGVyIGV2ZW50IGhhbmRsZXJzXG4gICAgICAgIHBvaW50ZXJIYW5kbGVyczogbnVsbCxcbiAgICAgICAgLy8gUGlja2VkIG9iamVjdHMgYXQgdGhlIHRpbWUgdGhlIHBvaW50ZXIgd2VudCBkb3duXG4gICAgICAgIHBvaW50ZXJEb3duUGlja3M6IG51bGwsXG4gICAgICAgIC8vIFNjcmVlbiBjb29yZGluYXRlcyB3aGVyZSB0aGUgcG9pbnRlciB3ZW50IGRvd25cbiAgICAgICAgcG9pbnRlckRvd25TY3JlZW5Db29yZHM6IG51bGwsXG4gICAgICAgIC8vIEdyb3VuZCBjb29yZGluYXRlcyB3aGVyZSB0aGUgcG9pbnRlciB3ZW50IGRvd25cbiAgICAgICAgcG9pbnRlckRvd25Hcm91bmRDb29yZHM6IG51bGwsXG4gICAgICAgIC8vIElzIHRoZSBwb2ludGVyIGRyYWdnaW5nIChwb2ludGVyIGRvd24gKyBtb3ZlZCBhdCBsZWFzdCBNSU5JTVVNX1BPSU5URVJfTU9WRV9USFJFU0hPTERfUElYRUxTKVxuICAgICAgICBpc0RyYWdnaW5nOiBmYWxzZVxuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgZmluYWxpemVTdGF0ZSgpIHtcbiAgICB0aGlzLl9yZW1vdmVQb2ludGVySGFuZGxlcnMoKTtcbiAgfVxuXG4gIHVwZGF0ZVN0YXRlKHsgcHJvcHMsIGNoYW5nZUZsYWdzIH06IE9iamVjdCkge1xuICAgIC8vIHVuc3Vic2NyaWJlIHByZXZpb3VzIGxheWVyIGluc3RhbmNlJ3MgaGFuZGxlcnNcbiAgICB0aGlzLl9yZW1vdmVQb2ludGVySGFuZGxlcnMoKTtcbiAgICB0aGlzLl9hZGRQb2ludGVySGFuZGxlcnMoKTtcbiAgfVxuXG4gIF9yZW1vdmVQb2ludGVySGFuZGxlcnMoKSB7XG4gICAgaWYgKHRoaXMuc3RhdGUuX2VkaXRhYmxlTGF5ZXJTdGF0ZS5wb2ludGVySGFuZGxlcnMpIHtcbiAgICAgIHRoaXMuY29udGV4dC5nbC5jYW52YXMucmVtb3ZlRXZlbnRMaXN0ZW5lcihcbiAgICAgICAgJ3BvaW50ZXJtb3ZlJyxcbiAgICAgICAgdGhpcy5zdGF0ZS5fZWRpdGFibGVMYXllclN0YXRlLnBvaW50ZXJIYW5kbGVycy5vblBvaW50ZXJNb3ZlXG4gICAgICApO1xuICAgICAgdGhpcy5jb250ZXh0LmdsLmNhbnZhcy5yZW1vdmVFdmVudExpc3RlbmVyKFxuICAgICAgICAncG9pbnRlcmRvd24nLFxuICAgICAgICB0aGlzLnN0YXRlLl9lZGl0YWJsZUxheWVyU3RhdGUucG9pbnRlckhhbmRsZXJzLm9uUG9pbnRlckRvd25cbiAgICAgICk7XG4gICAgICB0aGlzLmNvbnRleHQuZ2wuY2FudmFzLnJlbW92ZUV2ZW50TGlzdGVuZXIoXG4gICAgICAgICdwb2ludGVydXAnLFxuICAgICAgICB0aGlzLnN0YXRlLl9lZGl0YWJsZUxheWVyU3RhdGUucG9pbnRlckhhbmRsZXJzLm9uUG9pbnRlclVwXG4gICAgICApO1xuICAgIH1cbiAgICB0aGlzLnN0YXRlLl9lZGl0YWJsZUxheWVyU3RhdGUucG9pbnRlckhhbmRsZXJzID0gbnVsbDtcbiAgfVxuXG4gIF9hZGRQb2ludGVySGFuZGxlcnMoKSB7XG4gICAgdGhpcy5zdGF0ZS5fZWRpdGFibGVMYXllclN0YXRlLnBvaW50ZXJIYW5kbGVycyA9IHtcbiAgICAgIG9uUG9pbnRlck1vdmU6IHRoaXMuX29uUG9pbnRlck1vdmUuYmluZCh0aGlzKSxcbiAgICAgIG9uUG9pbnRlckRvd246IHRoaXMuX29uUG9pbnRlckRvd24uYmluZCh0aGlzKSxcbiAgICAgIG9uUG9pbnRlclVwOiB0aGlzLl9vblBvaW50ZXJVcC5iaW5kKHRoaXMpXG4gICAgfTtcblxuICAgIHRoaXMuY29udGV4dC5nbC5jYW52YXMuYWRkRXZlbnRMaXN0ZW5lcihcbiAgICAgICdwb2ludGVybW92ZScsXG4gICAgICB0aGlzLnN0YXRlLl9lZGl0YWJsZUxheWVyU3RhdGUucG9pbnRlckhhbmRsZXJzLm9uUG9pbnRlck1vdmVcbiAgICApO1xuICAgIHRoaXMuY29udGV4dC5nbC5jYW52YXMuYWRkRXZlbnRMaXN0ZW5lcihcbiAgICAgICdwb2ludGVyZG93bicsXG4gICAgICB0aGlzLnN0YXRlLl9lZGl0YWJsZUxheWVyU3RhdGUucG9pbnRlckhhbmRsZXJzLm9uUG9pbnRlckRvd25cbiAgICApO1xuICAgIHRoaXMuY29udGV4dC5nbC5jYW52YXMuYWRkRXZlbnRMaXN0ZW5lcihcbiAgICAgICdwb2ludGVydXAnLFxuICAgICAgdGhpcy5zdGF0ZS5fZWRpdGFibGVMYXllclN0YXRlLnBvaW50ZXJIYW5kbGVycy5vblBvaW50ZXJVcFxuICAgICk7XG4gIH1cblxuICBfb25Qb2ludGVyRG93bihldmVudDogT2JqZWN0KSB7XG4gICAgY29uc3Qgc2NyZWVuQ29vcmRzID0gdGhpcy5nZXRTY3JlZW5Db29yZHMoZXZlbnQpO1xuICAgIGNvbnN0IGdyb3VuZENvb3JkcyA9IHRoaXMuZ2V0R3JvdW5kQ29vcmRzKHNjcmVlbkNvb3Jkcyk7XG5cbiAgICBjb25zdCBwaWNrcyA9IHRoaXMuY29udGV4dC5sYXllck1hbmFnZXIucGlja09iamVjdCh7XG4gICAgICB4OiBzY3JlZW5Db29yZHNbMF0sXG4gICAgICB5OiBzY3JlZW5Db29yZHNbMV0sXG4gICAgICBtb2RlOiAncXVlcnknLFxuICAgICAgbGF5ZXJzOiBbdGhpcy5wcm9wcy5pZF0sXG4gICAgICByYWRpdXM6IDEwLFxuICAgICAgdmlld3BvcnRzOiBbdGhpcy5jb250ZXh0LnZpZXdwb3J0XVxuICAgIH0pO1xuXG4gICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICBfZWRpdGFibGVMYXllclN0YXRlOiB7XG4gICAgICAgIC4uLnRoaXMuc3RhdGUuX2VkaXRhYmxlTGF5ZXJTdGF0ZSxcbiAgICAgICAgcG9pbnRlckRvd25TY3JlZW5Db29yZHM6IHNjcmVlbkNvb3JkcyxcbiAgICAgICAgcG9pbnRlckRvd25Hcm91bmRDb29yZHM6IGdyb3VuZENvb3JkcyxcbiAgICAgICAgcG9pbnRlckRvd25QaWNrczogcGlja3MsXG4gICAgICAgIGlzRHJhZ2dpbmc6IGZhbHNlXG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBfb25Qb2ludGVyTW92ZShldmVudDogT2JqZWN0KSB7XG4gICAgY29uc3Qgc2NyZWVuQ29vcmRzID0gdGhpcy5nZXRTY3JlZW5Db29yZHMoZXZlbnQpO1xuICAgIGNvbnN0IGdyb3VuZENvb3JkcyA9IHRoaXMuZ2V0R3JvdW5kQ29vcmRzKHNjcmVlbkNvb3Jkcyk7XG5cbiAgICBjb25zdCB7XG4gICAgICBwb2ludGVyRG93blBpY2tzLFxuICAgICAgcG9pbnRlckRvd25TY3JlZW5Db29yZHMsXG4gICAgICBwb2ludGVyRG93bkdyb3VuZENvb3Jkc1xuICAgIH0gPSB0aGlzLnN0YXRlLl9lZGl0YWJsZUxheWVyU3RhdGU7XG5cbiAgICBsZXQgeyBpc0RyYWdnaW5nIH0gPSB0aGlzLnN0YXRlLl9lZGl0YWJsZUxheWVyU3RhdGU7XG5cbiAgICBpZiAocG9pbnRlckRvd25QaWNrcyAmJiBwb2ludGVyRG93blBpY2tzLmxlbmd0aCA+IDApIHtcbiAgICAgIC8vIFBvaW50ZXIgd2VudCBkb3duIG9uIHNvbWV0aGluZyBhbmQgaXMgbW92aW5nXG5cbiAgICAgIC8vIERpZCBpdCBtb3ZlIGVub3VnaCB0byBjb25zaWRlciBpdCBhIGRyYWdcbiAgICAgIGlmICghaXNEcmFnZ2luZyAmJiB0aGlzLm1vdmVkRW5vdWdoRm9yRHJhZyhwb2ludGVyRG93blNjcmVlbkNvb3Jkcywgc2NyZWVuQ29vcmRzKSkge1xuICAgICAgICAvLyBPSywgdGhpcyBpcyBjb25zaWRlcmVkIGRyYWdnaW5nXG5cbiAgICAgICAgLy8gRmlyZSB0aGUgc3RhcnQgZHJhZ2dpbmcgZXZlbnRcbiAgICAgICAgdGhpcy5vblN0YXJ0RHJhZ2dpbmcoe1xuICAgICAgICAgIHBpY2tzOiBwb2ludGVyRG93blBpY2tzLFxuICAgICAgICAgIHNjcmVlbkNvb3JkcyxcbiAgICAgICAgICBncm91bmRDb29yZHMsXG4gICAgICAgICAgZHJhZ1N0YXJ0U2NyZWVuQ29vcmRzOiBwb2ludGVyRG93blNjcmVlbkNvb3JkcyxcbiAgICAgICAgICBkcmFnU3RhcnRHcm91bmRDb29yZHM6IHBvaW50ZXJEb3duR3JvdW5kQ29vcmRzXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGlzRHJhZ2dpbmcgPSB0cnVlO1xuICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICBfZWRpdGFibGVMYXllclN0YXRlOiB7XG4gICAgICAgICAgICAuLi50aGlzLnN0YXRlLl9lZGl0YWJsZUxheWVyU3RhdGUsXG4gICAgICAgICAgICBpc0RyYWdnaW5nXG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICB0aGlzLm9uUG9pbnRlck1vdmUoe1xuICAgICAgc2NyZWVuQ29vcmRzLFxuICAgICAgZ3JvdW5kQ29vcmRzLFxuICAgICAgaXNEcmFnZ2luZyxcbiAgICAgIHBvaW50ZXJEb3duUGlja3MsXG4gICAgICBzb3VyY2VFdmVudDogZXZlbnRcbiAgICB9KTtcblxuICAgIGlmIChpc0RyYWdnaW5nKSB7XG4gICAgICB0aGlzLm9uRHJhZ2dpbmcoe1xuICAgICAgICBwaWNrczogcG9pbnRlckRvd25QaWNrcyxcbiAgICAgICAgc2NyZWVuQ29vcmRzLFxuICAgICAgICBncm91bmRDb29yZHMsXG4gICAgICAgIGRyYWdTdGFydFNjcmVlbkNvb3JkczogcG9pbnRlckRvd25TY3JlZW5Db29yZHMsXG4gICAgICAgIGRyYWdTdGFydEdyb3VuZENvb3JkczogcG9pbnRlckRvd25Hcm91bmRDb29yZHNcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIF9vblBvaW50ZXJVcChldmVudDogT2JqZWN0KSB7XG4gICAgY29uc3Qgc2NyZWVuQ29vcmRzID0gdGhpcy5nZXRTY3JlZW5Db29yZHMoZXZlbnQpO1xuICAgIGNvbnN0IGdyb3VuZENvb3JkcyA9IHRoaXMuZ2V0R3JvdW5kQ29vcmRzKHNjcmVlbkNvb3Jkcyk7XG5cbiAgICBjb25zdCB7XG4gICAgICBwb2ludGVyRG93blBpY2tzLFxuICAgICAgcG9pbnRlckRvd25TY3JlZW5Db29yZHMsXG4gICAgICBwb2ludGVyRG93bkdyb3VuZENvb3JkcyxcbiAgICAgIGlzRHJhZ2dpbmdcbiAgICB9ID0gdGhpcy5zdGF0ZS5fZWRpdGFibGVMYXllclN0YXRlO1xuXG4gICAgaWYgKCFwb2ludGVyRG93blNjcmVlbkNvb3Jkcykge1xuICAgICAgLy8gVGhpcyBpcyBhIHBvaW50ZXIgdXAgd2l0aG91dCBhIHBvaW50ZXIgZG93biAoZS5nLiB1c2VyIHBvaW50ZXIgZG93bmVkIGVsc2V3aGVyZSksIHNvIGlnbm9yZVxuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmIChpc0RyYWdnaW5nKSB7XG4gICAgICB0aGlzLm9uU3RvcERyYWdnaW5nKHtcbiAgICAgICAgcGlja3M6IHBvaW50ZXJEb3duUGlja3MsXG4gICAgICAgIHNjcmVlbkNvb3JkcyxcbiAgICAgICAgZ3JvdW5kQ29vcmRzLFxuICAgICAgICBkcmFnU3RhcnRTY3JlZW5Db29yZHM6IHBvaW50ZXJEb3duU2NyZWVuQ29vcmRzLFxuICAgICAgICBkcmFnU3RhcnRHcm91bmRDb29yZHM6IHBvaW50ZXJEb3duR3JvdW5kQ29vcmRzXG4gICAgICB9KTtcbiAgICB9IGVsc2UgaWYgKCF0aGlzLm1vdmVkRW5vdWdoRm9yRHJhZyhwb2ludGVyRG93blNjcmVlbkNvb3Jkcywgc2NyZWVuQ29vcmRzKSkge1xuICAgICAgdGhpcy5vbkNsaWNrKHtcbiAgICAgICAgcGlja3M6IHBvaW50ZXJEb3duUGlja3MsXG4gICAgICAgIHNjcmVlbkNvb3JkcyxcbiAgICAgICAgZ3JvdW5kQ29vcmRzXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgIF9lZGl0YWJsZUxheWVyU3RhdGU6IHtcbiAgICAgICAgLi4udGhpcy5zdGF0ZS5fZWRpdGFibGVMYXllclN0YXRlLFxuICAgICAgICBwb2ludGVyRG93blNjcmVlbkNvb3JkczogbnVsbCxcbiAgICAgICAgcG9pbnRlckRvd25Hcm91bmRDb29yZHM6IG51bGwsXG4gICAgICAgIHBvaW50ZXJEb3duUGlja3M6IG51bGwsXG4gICAgICAgIGlzRHJhZ2dpbmc6IGZhbHNlXG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBnZXRTY3JlZW5Db29yZHMocG9pbnRlckV2ZW50OiBPYmplY3QpIHtcbiAgICByZXR1cm4gW1xuICAgICAgcG9pbnRlckV2ZW50LmNsaWVudFggLSB0aGlzLmNvbnRleHQuZ2wuY2FudmFzLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLngsXG4gICAgICBwb2ludGVyRXZlbnQuY2xpZW50WSAtIHRoaXMuY29udGV4dC5nbC5jYW52YXMuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkueVxuICAgIF07XG4gIH1cblxuICBnZXRHcm91bmRDb29yZHMoc2NyZWVuQ29vcmRzOiBudW1iZXJbXSkge1xuICAgIHJldHVybiB0aGlzLmNvbnRleHQudmlld3BvcnQudW5wcm9qZWN0KFtzY3JlZW5Db29yZHNbMF0sIHNjcmVlbkNvb3Jkc1sxXV0pO1xuICB9XG5cbiAgbW92ZWRFbm91Z2hGb3JEcmFnKHNjcmVlbkNvb3JkczE6IG51bWJlcltdLCBzY3JlZW5Db29yZHMyOiBudW1iZXJbXSkge1xuICAgIHJldHVybiAoXG4gICAgICBNYXRoLmFicyhzY3JlZW5Db29yZHMxWzBdIC0gc2NyZWVuQ29vcmRzMlswXSkgPiBNSU5JTVVNX1BPSU5URVJfTU9WRV9USFJFU0hPTERfUElYRUxTIHx8XG4gICAgICBNYXRoLmFicyhzY3JlZW5Db29yZHMxWzFdIC0gc2NyZWVuQ29vcmRzMlsxXSkgPiBNSU5JTVVNX1BPSU5URVJfTU9WRV9USFJFU0hPTERfUElYRUxTXG4gICAgKTtcbiAgfVxufVxuXG5FZGl0YWJsZUxheWVyLmxheWVyTmFtZSA9ICdFZGl0YWJsZUxheWVyJztcbiJdfQ==