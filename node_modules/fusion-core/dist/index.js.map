{"version":3,"file":"index.js","sources":["../src/create-plugin.js","../src/create-token.js","../src/tokens.js","../src/sanitization.js","../src/plugins/ssr.js","../src/base-app.js","../src/compose.js","../src/memoize.js","../src/plugins/timing.js","../src/plugins/server-renderer.js","../src/get-env.js","../src/plugins/server-context.js","../src/server-app.js","../src/plugins/client-hydrate.js","../src/plugins/client-renderer.js","../src/client-app.js","../src/virtual/index.js","../src/index.js"],"sourcesContent":["/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport type {FusionPlugin} from './types.js';\n\n// eslint-disable-next-line flowtype/generic-spacing\ntype FusionPluginNoHidden<TDeps, TService> = $Diff<\n  FusionPlugin<TDeps, TService>,\n  {__plugin__: boolean}\n>;\n\nexport function createPlugin<TDeps, TService>(\n  opts: $Exact<FusionPluginNoHidden<TDeps, TService>>\n): FusionPlugin<TDeps, TService> {\n  return {\n    __plugin__: true,\n    ...opts,\n  };\n}\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport type {Token} from './types.js';\n\nexport const TokenType = {\n  Required: 0,\n  Optional: 1,\n};\nfunction Ref() {}\nexport class TokenImpl<TResolved> {\n  name: string;\n  ref: mixed;\n  type: $Values<typeof TokenType>;\n  optional: ?TokenImpl<TResolved>;\n\n  constructor(name: string, ref: mixed) {\n    this.name = name;\n    this.ref = ref || new Ref();\n    this.type = ref ? TokenType.Optional : TokenType.Required;\n    if (!ref) {\n      this.optional = new TokenImpl(name, this.ref);\n    }\n  }\n}\n\nexport function createToken<TResolvedType>(name: string): Token<TResolvedType> {\n  // $FlowFixMe\n  return new TokenImpl(name);\n}\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport {createToken} from './create-token';\nimport type {SSRDecider, Token} from './types.js';\n\nexport const RenderToken = createToken('RenderToken');\nexport const ElementToken = createToken('ElementToken');\nexport const SSRDeciderToken: Token<SSRDecider> = createToken(\n  'SSRDeciderToken'\n);\nexport const HttpServerToken = createToken('HttpServerToken');\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n/*\nWe never want developers to be able to write `ctx.template.body.push(`<div>${stuff}</div>`)`\nbecause that allows XSS attacks by default (e.g. if stuff === '<script>alert(1)</script>')\nInstead, they should use html`<div>{stuff}</div>` so interpolated data gets automatically escaped\nWe trust the markup outside of interpolation because it's code written by a developer with commit permissions,\nwhich can be audited via code reviews\n*/\n\nimport type {SanitizedHTMLWrapper} from './types.js';\n\n// eslint-disable-next-line import/no-mutable-exports\nlet html, dangerouslySetHTML, consumeSanitizedHTML, escape;\nif (__NODE__) {\n  const forbiddenChars = {\n    '<': '\\\\u003C',\n    '>': '\\\\u003E',\n    '\"': '\\\\u0022',\n    '/': '\\\\u002F',\n    '\\u2028': '\\\\u2028',\n    '\\u2029': '\\\\u2029',\n  };\n  const replaceForbidden = c => forbiddenChars[c];\n\n  const key = Symbol('sanitized html');\n  html = (\n    [head, ...rest]: Array<string>,\n    ...values: Array<string>\n  ): SanitizedHTMLWrapper => {\n    const obj = {};\n    Object.defineProperty(obj, key, {\n      enumerable: false,\n      configurable: false,\n      value: head + values.map((s, i) => escape(s) + rest[i]).join(''),\n    });\n    return obj;\n  };\n  dangerouslySetHTML = (str: string): Object => html([str]);\n  escape = (str: any): string => {\n    if (str && str[key]) return consumeSanitizedHTML(str);\n    return String(str).replace(/[<>\"/\\u2028\\u2029]/g, replaceForbidden);\n  };\n  consumeSanitizedHTML = (h: SanitizedHTMLWrapper): string => {\n    if (typeof h === 'string') {\n      throw new Error(`Unsanitized html. Use html\\`${h}\\``);\n    }\n    return h[key];\n  };\n}\nconst replaceEscaped = c => String.fromCodePoint(parseInt(c.slice(2), 16));\nconst unescape = (str: string): string => {\n  return str.replace(\n    /\\\\u003C|\\\\u003E|\\\\u0022|\\\\u002F|\\\\u2028|\\\\u2029/g,\n    replaceEscaped\n  );\n};\n\n// These types are necessary due to not having an assignment in the __BROWSER__ environment\nconst flowHtml = ((html: any): (\n  strings: Array<string>,\n  ...expressions: Array<string>\n) => SanitizedHTMLWrapper);\n\nconst flowDangerouslySetHTML = ((dangerouslySetHTML: any): (\n  html: string\n) => Object);\n\nconst flowConsumeSanitizedHTML = ((consumeSanitizedHTML: any): (\n  str: SanitizedHTMLWrapper\n) => string);\n\nconst flowEscape = ((escape: any): (str: string) => string);\n\nexport {\n  flowHtml as html,\n  flowDangerouslySetHTML as dangerouslySetHTML,\n  flowConsumeSanitizedHTML as consumeSanitizedHTML,\n  flowEscape as escape,\n  unescape,\n};\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport path from 'path';\nimport {createPlugin} from '../create-plugin';\nimport {escape, consumeSanitizedHTML} from '../sanitization';\nimport type {Context, SSRDecider as SSRDeciderService} from '../types.js';\n\nconst SSRDecider = createPlugin({\n  provides: () => {\n    return ctx => {\n      // If the request has one of these extensions, we assume it's not something that requires server-side rendering of virtual dom\n      // TODO(#46): this check should probably look at the asset manifest to ensure asset 404s are handled correctly\n      if (ctx.path.match(/\\.(js|gif|jpg|png|pdf|json)$/)) return false;\n      // The Accept header is a good proxy for whether SSR should happen\n      // Requesting an HTML page via the browser url bar generates a request with `text/html` in its Accept headers\n      // XHR/fetch requests do not have `text/html` in the Accept headers\n      if (!ctx.headers.accept) return false;\n      if (!ctx.headers.accept.includes('text/html')) return false;\n      return true;\n    };\n  },\n});\nexport {SSRDecider};\n\nexport default function createSSRPlugin({\n  element,\n  ssrDecider,\n}: {\n  element: any,\n  ssrDecider: SSRDeciderService,\n}) {\n  return async function ssrPlugin(ctx: Context, next: () => Promise<void>) {\n    if (!ssrDecider(ctx)) return next();\n\n    const template = {\n      htmlAttrs: {},\n      bodyAttrs: {},\n      title: '',\n      head: [],\n      body: [],\n    };\n    ctx.element = element;\n    ctx.rendered = '';\n    ctx.template = template;\n    ctx.type = 'text/html';\n\n    await next();\n\n    // Allow someone to override the ssr by setting ctx.body\n    // This is especially useful for things like ctx.redirect\n    if (ctx.body && ctx.respond !== false) {\n      return;\n    }\n\n    const {htmlAttrs, bodyAttrs, title, head, body} = ctx.template;\n    const safeAttrs = Object.keys(htmlAttrs)\n      .map(attrKey => {\n        return ` ${escape(attrKey)}=\"${escape(htmlAttrs[attrKey])}\"`;\n      })\n      .join('');\n\n    const safeBodyAttrs = Object.keys(bodyAttrs)\n      .map(attrKey => {\n        return ` ${escape(attrKey)}=\"${escape(bodyAttrs[attrKey])}\"`;\n      })\n      .join('');\n\n    const safeTitle = escape(title);\n    // $FlowFixMe\n    const safeHead = head.map(consumeSanitizedHTML).join('');\n    // $FlowFixMe\n    const safeBody = body.map(consumeSanitizedHTML).join('');\n\n    const preloadHintLinks = getPreloadHintLinks(ctx);\n    const coreGlobals = getCoreGlobals(ctx);\n    const chunkScripts = getChunkScripts(ctx);\n    const bundleSplittingBootstrap = [\n      preloadHintLinks,\n      coreGlobals,\n      chunkScripts,\n    ].join('');\n\n    const chunkPreloaderScript = getChunkPreloaderScript(ctx);\n\n    ctx.body = [\n      '<!doctype html>',\n      `<html${safeAttrs}>`,\n      `<head>`,\n      `<meta charset=\"utf-8\" />`,\n      `<title>${safeTitle}</title>`,\n      `${bundleSplittingBootstrap}${safeHead}`,\n      `</head>`,\n      `<body${safeBodyAttrs}>${\n        ctx.rendered\n      }${safeBody}${chunkPreloaderScript}</body>`,\n      '</html>',\n    ].join('');\n  };\n}\n\nfunction getCoreGlobals(ctx) {\n  const {chunkUrlMap, webpackPublicPath, nonce} = ctx;\n\n  const chunkManifest = {};\n  Array.from(chunkUrlMap.entries()).forEach(([id, variant]) => {\n    if (variant) {\n      const filepath = /*variant.get(ctx.esVersion) || */ variant.get('es5');\n      chunkManifest[id] = path.basename(filepath);\n    }\n  }, {});\n  const serializedManifest = JSON.stringify(chunkManifest);\n  const hasManifest = Object.keys(chunkManifest).length > 0;\n  const manifest = hasManifest ? `__MANIFEST__ = ${serializedManifest};` : ''; // consumed by webpack\n\n  return [\n    `<script nonce=\"${nonce}\">`,\n    `window.performance && window.performance.mark && window.performance.mark('firstRenderStart');`,\n    `__ROUTE_PREFIX__ = ${JSON.stringify(ctx.prefix)};`, // consumed by ./client\n    `__WEBPACK_PUBLIC_PATH__ = ${JSON.stringify(webpackPublicPath)};`, // consumed by fusion-clientries/client-entry\n    manifest,\n    `</script>`,\n  ].join('');\n}\n\nfunction getUrls({chunkUrlMap, webpackPublicPath}, chunks) {\n  return chunks.map(id => {\n    let url = chunkUrlMap.get(id).get('es5');\n    if (webpackPublicPath.endsWith('/')) {\n      url = webpackPublicPath + url;\n    } else {\n      url = webpackPublicPath + '/' + url;\n    }\n    return {id, url};\n  });\n}\n\nfunction getChunkScripts(ctx) {\n  const webpackPublicPath = ctx.webpackPublicPath || '';\n  // cross origin is needed to get meaningful errors in window.onerror\n  const crossOrigin = webpackPublicPath.startsWith('https://')\n    ? ' crossorigin=\"anonymous\"'\n    : '';\n  const sync = getUrls(ctx, ctx.syncChunks).map(({url}) => {\n    return `<script defer${crossOrigin} src=\"${url}\"></script>`;\n  });\n  const preloaded = getUrls(ctx, ctx.preloadChunks).map(({id, url}) => {\n    return `<script defer${crossOrigin} src=\"${url}\" data-webpack-preload=\"${id}\"></script>`;\n  });\n  return [...preloaded, ...sync].join('');\n}\n\nfunction getPreloadHintLinks(ctx) {\n  const chunks = [...ctx.preloadChunks, ...ctx.syncChunks];\n  const hints = getUrls(ctx, chunks).map(({url}) => {\n    return `<link rel=\"preload\" href=\"${url}\" as=\"script\" />`;\n  });\n  return hints.join('');\n}\n\nfunction getChunkPreloaderScript({nonce = '', preloadChunks}) {\n  // NOTE: the event listeners below are not needed if inline onerror event handlers are allowed by CSP.\n  // However, this is disallowed currently.\n  return trim(`\n  <script nonce=\"${nonce}\">\n  (function(){\n    __PRELOADED_CHUNKS__ = ${JSON.stringify(preloadChunks)};\n    function onError(e) {\n      var el = e.target;\n      if (el.nodeName !== \"SCRIPT\") return;\n      var val = el.getAttribute(\"data-webpack-preload\");\n      if (val === null) return;\n      var id = parseInt(val, 10);\n      if (__HANDLE_ERROR) return __HANDLE_ERROR(id);\n      if (!__UNHANDLED_ERRORS__) __UNHANDLED_ERRORS__ = [];\n      __UNHANDLED_ERRORS__.push(id);\n    }\n    addEventListener(\"error\", onError, true);\n    addEventListener(\"load\", function() {\n        removeEventListener(\"error\", onError);\n    });\n  })();\n  </script>`);\n}\n\nfunction trim(str) {\n  return str.replace(/^\\s+/gm, '');\n}\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport {createPlugin} from './create-plugin';\nimport {createToken, TokenType, TokenImpl} from './create-token';\nimport {ElementToken, RenderToken, SSRDeciderToken} from './tokens';\nimport {SSRDecider} from './plugins/ssr';\n\nimport type {aliaser, cleanupFn, FusionPlugin, Token} from './types.js';\n\nclass FusionApp {\n  constructor(el: Element | string, render: *) {\n    this.registered = new Map(); // getTokenRef(token) -> {value, aliases, enhancers}\n    this.enhancerToToken = new Map(); // enhancer -> token\n    this.plugins = []; // Token\n    this.cleanups = [];\n    el && this.register(ElementToken, el);\n    render && this.register(RenderToken, render);\n    this.register(SSRDeciderToken, SSRDecider);\n  }\n\n  // eslint-disable-next-line\n  registered: Map<\n    any,\n    {\n      aliases?: Map<any, any>,\n      enhancers?: Array<any>,\n      token: any,\n      value?: FusionPlugin<*, *>,\n    }\n  >;\n  enhancerToToken: Map<any, any>;\n  plugins: Array<any>;\n  cleanups: Array<cleanupFn>;\n  renderer: any;\n\n  register(token: *, value: *): aliaser<*> {\n    // $FlowFixMe\n    if (token && token.__plugin__) {\n      value = token;\n      token = createToken('UnnamedPlugin');\n    }\n    if (!(token instanceof TokenImpl) && value === undefined) {\n      throw new Error(\n        __DEV__\n          ? `Cannot register ${String(\n              token\n            )} without a token. Did you accidentally register a ${\n              __NODE__ ? 'browser' : 'server'\n            } plugin on the ${__NODE__ ? 'server' : 'browser'}?`\n          : 'Invalid configuration registration'\n      );\n    }\n    // the renderer is a special case, since it needs to be always run last\n    if (token === RenderToken) {\n      this.renderer = value;\n      return {\n        alias: () => {\n          throw new Error('Aliasing for RenderToken not supported.');\n        },\n      };\n    }\n    return this._register(token, value);\n  }\n  _register<TResolved>(token: Token<TResolved>, value: *) {\n    this.plugins.push(token);\n    const {aliases, enhancers} = this.registered.get(getTokenRef(token)) || {\n      aliases: new Map(),\n      enhancers: [],\n    };\n    this.registered.set(getTokenRef(token), {value, aliases, enhancers, token});\n    function alias(sourceToken: *, destToken: *) {\n      if (aliases) {\n        aliases.set(sourceToken, destToken);\n      }\n      return {alias};\n    }\n    return {alias};\n  }\n  middleware(deps: *, middleware: *) {\n    if (middleware === undefined) {\n      middleware = () => deps;\n    }\n    this.register(createPlugin({deps, middleware}));\n  }\n  enhance<TResolved>(token: Token<TResolved>, enhancer: Function) {\n    const {value, aliases, enhancers} = this.registered.get(\n      getTokenRef(token)\n    ) || {\n      aliases: new Map(),\n      enhancers: [],\n      value: undefined,\n    };\n    this.enhancerToToken.set(enhancer, token);\n\n    if (enhancers && Array.isArray(enhancers)) {\n      enhancers.push(enhancer);\n    }\n    this.registered.set(getTokenRef(token), {value, aliases, enhancers, token});\n  }\n  cleanup() {\n    return Promise.all(this.cleanups.map(fn => fn()));\n  }\n  resolve<TResolved>() {\n    if (!this.renderer) {\n      throw new Error('Missing registration for RenderToken');\n    }\n    this._register(RenderToken, this.renderer);\n    const resolved = new Map(); // Token.ref || Token => Service\n    const dependedOn = new Set(); // Token.ref || Token\n    const nonPluginTokens = new Set(); // Token\n    const resolving = new Set(); // Token.ref || Token\n    const registered = this.registered; // Token.ref || Token -> {value, aliases, enhancers}\n    const resolvedPlugins = []; // Plugins\n    const allAliases = new Set(); // Token.ref || Token\n    const appliedEnhancers = [];\n    const resolveToken = (token: Token<TResolved>, tokenAliases) => {\n      // Base: if we have already resolved the type, return it\n      if (tokenAliases && tokenAliases.has(token)) {\n        const newToken = tokenAliases.get(token);\n        allAliases.add([getTokenRef(token), getTokenRef(newToken)]);\n        if (newToken) {\n          token = newToken;\n        }\n      }\n      if (resolved.has(getTokenRef(token))) {\n        return resolved.get(getTokenRef(token));\n      }\n\n      // Base: if currently resolving the same type, we have a circular dependency\n      if (resolving.has(getTokenRef(token))) {\n        throw new Error(`Cannot resolve circular dependency: ${token.name}`);\n      }\n\n      // Base: the type was never registered, throw error or provide undefined if optional\n      let {value, aliases, enhancers} =\n        registered.get(getTokenRef(token)) || {};\n      if (value === undefined) {\n        // Attempt to get default value, if optional\n        if (token instanceof TokenImpl && token.type === TokenType.Optional) {\n          this.register(token, undefined);\n        } else {\n          const dependents = Array.from(this.registered.entries());\n\n          /**\n           * Iterate over the entire list of dependencies and find all\n           * dependencies of a given token.\n           */\n          const findDependentTokens = () => {\n            return dependents\n              .filter(entry => {\n                if (!entry[1].value || !entry[1].value.deps) {\n                  return false;\n                }\n                return Object.values(entry[1].value.deps).includes(token);\n              })\n              .map(entry => entry[1].token.name);\n          };\n          const findDependentEnhancers = () => {\n            return appliedEnhancers\n              .filter(([, provides]) => {\n                if (!provides || !provides.deps) {\n                  return false;\n                }\n                return Object.values(provides.deps).includes(token);\n              })\n              .map(([enhancer]) => {\n                const enhancedToken = this.enhancerToToken.get(enhancer);\n                return `EnhancerOf<${\n                  enhancedToken ? enhancedToken.name : '(unknown)'\n                }>`;\n              });\n          };\n          const dependentTokens = [\n            ...findDependentTokens(),\n            ...findDependentEnhancers(),\n          ];\n\n          // otherwise, we cannot resolve this token\n          throw new Error(\n            `Could not resolve token: \"${\n              token ? token.name : '(unknown)'\n            }\", which is required by plugins registered with tokens: ${dependentTokens\n              .map(token => `\"${token}\"`)\n              .join(', ')}. Did you forget to register a value for \"${\n              token ? token.name : '(unknown)'\n            }\"?`\n          );\n        }\n      }\n\n      // Recursive: get the registered type and resolve it\n      resolving.add(getTokenRef(token));\n\n      function resolvePlugin(plugin) {\n        const registeredDeps = (plugin && plugin.deps) || {};\n        const resolvedDeps = {};\n        for (const key in registeredDeps) {\n          const registeredToken = registeredDeps[key];\n          dependedOn.add(getTokenRef(registeredToken));\n          resolvedDeps[key] = resolveToken(registeredToken, aliases);\n        }\n        // `provides` should be undefined if the plugin does not have a `provides` function\n        let provides =\n          plugin && plugin.provides ? plugin.provides(resolvedDeps) : undefined;\n        if (plugin && plugin.middleware) {\n          resolvedPlugins.push(plugin.middleware(resolvedDeps, provides));\n        }\n        return provides;\n      }\n\n      let provides = value;\n      if (value && value.__plugin__) {\n        provides = resolvePlugin(provides);\n        if (value.cleanup) {\n          this.cleanups.push(function() {\n            return typeof value.cleanup === 'function'\n              ? value.cleanup(provides)\n              : Promise.resolve();\n          });\n        }\n      } else {\n        nonPluginTokens.add(token);\n      }\n\n      if (enhancers && enhancers.length) {\n        enhancers.forEach(e => {\n          let nextProvides = e(provides);\n          appliedEnhancers.push([e, nextProvides]);\n          if (nextProvides && nextProvides.__plugin__) {\n            nextProvides = resolvePlugin(nextProvides);\n          }\n          provides = nextProvides;\n        });\n      }\n      resolved.set(getTokenRef(token), provides);\n      resolving.delete(getTokenRef(token));\n      return provides;\n    };\n\n    for (let i = 0; i < this.plugins.length; i++) {\n      resolveToken(this.plugins[i]);\n    }\n    for (const aliasPair of allAliases) {\n      const [sourceTokenRef, destTokenRef] = aliasPair;\n      if (dependedOn.has(sourceTokenRef)) {\n        dependedOn.add(destTokenRef);\n      }\n    }\n    for (const token of nonPluginTokens) {\n      if (!dependedOn.has(getTokenRef(token))) {\n        throw new Error(\n          `Registered token without depending on it: \"${token.name}\"`\n        );\n      }\n    }\n    this.plugins = resolvedPlugins;\n  }\n}\n\n/* Helper functions */\nfunction getTokenRef(token) {\n  if (token instanceof TokenImpl) {\n    return token.ref;\n  }\n  return token;\n}\n\nexport default FusionApp;\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport type {Middleware} from './types.js';\n\n// inline version of koa-compose to get around Rollup/CUP commonjs-related issue\nexport function compose(middleware: Array<Middleware>): Middleware {\n  if (!Array.isArray(middleware)) {\n    throw new TypeError('Middleware stack must be an array!');\n  }\n  for (const fn of middleware) {\n    if (typeof fn !== 'function') {\n      throw new TypeError(\n        `Expected middleware function, received: ${typeof fn}`\n      );\n    }\n  }\n\n  return function(context, next) {\n    let index = -1;\n    return dispatch(0);\n    function dispatch(i) {\n      if (i <= index) {\n        return Promise.reject(new Error('next() called multiple times'));\n      }\n      index = i;\n      let fn = middleware[i];\n      if (i === middleware.length) fn = next;\n      if (!fn) return Promise.resolve();\n      try {\n        // $FlowFixMe\n        return fn(context, function next() {\n          return dispatch(i + 1);\n        });\n      } catch (err) {\n        return Promise.reject(err);\n      }\n    }\n  };\n}\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport type {Context} from './types.js';\n\ntype MemoizeFn<A> = (ctx: Context) => A;\n\nfunction Container() {}\n\nexport function memoize<A>(fn: MemoizeFn<A>): MemoizeFn<A> {\n  const memoizeKey = __NODE__ ? Symbol('memoize-key') : new Container();\n  return function memoized(ctx: Context) {\n    if (ctx.memoized.has(memoizeKey)) {\n      return ctx.memoized.get(memoizeKey);\n    }\n    const result = fn(ctx);\n    ctx.memoized.set(memoizeKey, result);\n    return result;\n  };\n}\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\nimport {createPlugin} from '../create-plugin';\nimport {memoize} from '../memoize';\nimport {createToken} from '../create-token';\nimport type {Token} from '../types.js';\n\ntype Deferred<T> = {\n  promise: Promise<T>,\n  resolve: (result: T) => void,\n  reject: (error: Error) => void,\n};\n\nclass Timing {\n  start: number;\n  render: Deferred<number>;\n  end: Deferred<number>;\n  downstream: Deferred<number>;\n  upstream: Deferred<number>;\n  upstreamStart: number;\n  constructor() {\n    this.start = now();\n    this.render = deferred();\n    this.end = deferred();\n    this.downstream = deferred();\n    this.upstream = deferred();\n    this.upstreamStart = -1;\n  }\n}\ntype TimingPlugin = {\n  from(ctx: Object): Timing,\n};\n\nconst timing: TimingPlugin = {\n  from: memoize(() => new Timing()),\n};\n\nexport const TimingToken: Token<TimingPlugin> = createToken('TimingToken');\n\nfunction middleware(ctx, next) {\n  ctx.memoized = new Map();\n  const {start, render, end, downstream, upstream} = timing.from(ctx);\n  ctx.timing = {\n    start,\n    render: render.promise,\n    end: end.promise,\n    downstream: downstream.promise,\n    upstream: upstream.promise,\n  };\n  return next().then(() => {\n    const upstreamTime = now() - timing.from(ctx).upstreamStart;\n    upstream.resolve(upstreamTime);\n    const endTime = now() - ctx.timing.start;\n    end.resolve(endTime);\n  });\n}\n\nexport default createPlugin({\n  provides: () => timing,\n  middleware: () => middleware,\n});\n\nexport function now(): number {\n  if (__NODE__) {\n    const [seconds, ns] = process.hrtime();\n    return Math.round(seconds * 1000 + ns / 1e6);\n  } else {\n    // eslint-disable-next-line cup/no-undef\n    if (window.performance && window.performance.now) {\n      // eslint-disable-next-line cup/no-undef\n      return Math.round(window.performance.now());\n    }\n    return Date.now();\n  }\n}\n\nfunction deferred<T>(): Deferred<T> {\n  let resolve = () => {};\n  let reject = () => {};\n  const promise = new Promise((res, rej) => {\n    resolve = res;\n    reject = rej;\n  });\n  return {\n    promise,\n    resolve,\n    reject,\n  };\n}\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport {now} from './timing';\n\nimport type {Context} from '../types.js';\n\nexport default function getRendererPlugin({\n  render,\n  timing,\n}: {\n  render: any,\n  timing: any,\n}) {\n  return async function renderer(ctx: Context, next: () => Promise<void>) {\n    const timer = timing.from(ctx);\n    timer.downstream.resolve(now() - timer.start);\n\n    let renderTime = null;\n    if (ctx.element && !ctx.body && ctx.respond !== false) {\n      const renderStart = now();\n      ctx.rendered = await render(ctx.element);\n      renderTime = now() - renderStart;\n    }\n\n    timer.upstreamStart = now();\n    await next();\n\n    if (ctx.element && typeof renderTime === 'number') {\n      timer.render.resolve(renderTime);\n    }\n  };\n}\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n/* eslint-env node */\nimport assert from 'assert';\n\nexport default (__BROWSER__ ? () => {} : loadEnv());\n\nfunction load(key, value) {\n  return process.env[key] || value;\n}\n\nexport function loadEnv() {\n  const rootDir = load('ROOT_DIR', '.');\n  const env = load('NODE_ENV', 'development');\n  if (!(env === 'development' || env === 'production' || env === 'test')) {\n    throw new Error(`Invalid NODE_ENV loaded: ${env}.`);\n  }\n  const prefix = load('ROUTE_PREFIX', '');\n  assert(!prefix.endsWith('/'), 'ROUTE_PREFIX must not end with /');\n  const baseAssetPath = load('FRAMEWORK_STATIC_ASSET_PATH', `/_static`);\n  assert(\n    !baseAssetPath.endsWith('/'),\n    'FRAMEWORK_STATIC_ASSET_PATH must not end with /'\n  );\n  const cdnUrl = load('CDN_URL', '');\n  assert(!cdnUrl.endsWith('/'), 'CDN_URL must not end with /');\n\n  const assetPath = `${prefix}${baseAssetPath}`;\n  return function loadEnv(): Env {\n    return {\n      rootDir,\n      env,\n      prefix,\n      assetPath,\n      baseAssetPath,\n      cdnUrl,\n      webpackPublicPath: cdnUrl || assetPath,\n    };\n  };\n}\n\n// Handle flow-types for export so browser export is ignored.\ntype Env = {\n  rootDir: string,\n  env: string,\n  prefix: string,\n  assetPath: string,\n  baseAssetPath: string,\n  cdnUrl: string,\n  webpackPublicPath: string,\n};\ndeclare export default () => Env;\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport uuidv4 from 'uuid/v4';\nimport UAParser from 'ua-parser-js';\nimport getEnv from '../get-env.js';\n\nimport type {Context} from '../types.js';\n\nconst envVars = getEnv();\n\nexport default function middleware(ctx: Context, next: () => Promise<void>) {\n  // env vars\n  ctx.rootDir = envVars.rootDir;\n  ctx.env = envVars.env;\n  ctx.prefix = envVars.prefix;\n  ctx.assetPath = envVars.assetPath;\n  ctx.cdnUrl = envVars.cdnUrl;\n\n  // webpack-related things\n  ctx.preloadChunks = [];\n  ctx.webpackPublicPath =\n    ctx.webpackPublicPath || envVars.cdnUrl || envVars.assetPath;\n\n  // these are set by fusion-cli, however since fusion-cli plugins are not added when\n  // running simulation tests, it is good to default them here\n  ctx.syncChunks = ctx.syncChunks || [];\n  ctx.chunkUrlMap = ctx.chunkUrlMap || new Map();\n\n  // fusion-specific things\n  ctx.nonce = uuidv4();\n  ctx.useragent = new UAParser(ctx.headers['user-agent']).getResult();\n  ctx.element = null;\n  ctx.rendered = null;\n\n  return next();\n}\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n/* eslint-env node */\nimport {compose} from './compose.js';\nimport Timing, {TimingToken} from './plugins/timing';\nimport BaseApp from './base-app';\nimport serverRenderer from './plugins/server-renderer';\nimport {RenderToken, ElementToken, SSRDeciderToken} from './tokens';\nimport ssrPlugin from './plugins/ssr';\nimport contextMiddleware from './plugins/server-context.js';\n\nexport default function(): typeof BaseApp {\n  const Koa = require('koa');\n\n  return class ServerApp extends BaseApp {\n    _app: Koa;\n    constructor(el, render) {\n      super(el, render);\n      this._app = new Koa();\n      this.middleware(contextMiddleware);\n      this.register(TimingToken, Timing);\n      this.middleware(\n        {element: ElementToken, ssrDecider: SSRDeciderToken},\n        ssrPlugin\n      );\n    }\n    resolve() {\n      this.middleware(\n        {timing: TimingToken, render: RenderToken},\n        serverRenderer\n      );\n      return super.resolve();\n    }\n    callback() {\n      this.resolve();\n      this._app.use(compose(this.plugins));\n      return this._app.callback();\n    }\n  };\n}\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\n/* eslint-env browser */\n\nimport type {Context} from '../types.js';\n\nexport default function createClientHydrate({element}: {element: any}) {\n  return function clientHydrate(ctx: Context, next: () => Promise<void>) {\n    ctx.prefix = window.__ROUTE_PREFIX__ || ''; // serialized by ./server\n    ctx.element = element;\n    ctx.preloadChunks = [];\n    return next();\n  };\n}\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport type {Context} from '../types.js';\n\nexport default function createClientRenderer({render}: {render: any}) {\n  return function renderer(ctx: Context, next: () => Promise<void>) {\n    const rendered = render(ctx.element);\n    if (rendered instanceof Promise) {\n      return rendered.then(r => {\n        ctx.rendered = r;\n        return next();\n      });\n    } else {\n      ctx.rendered = rendered;\n      return next();\n    }\n  };\n}\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n/* eslint-env browser */\nimport {compose} from './compose.js';\nimport timing, {TimingToken} from './plugins/timing';\nimport BaseApp from './base-app';\nimport createClientHydrate from './plugins/client-hydrate';\nimport createClientRenderer from './plugins/client-renderer';\nimport {RenderToken, ElementToken} from './tokens';\n\nexport default function(): typeof BaseApp {\n  return class ClientApp extends BaseApp {\n    constructor(el, render) {\n      super(el, render);\n      this.register(TimingToken, timing);\n      this.middleware({element: ElementToken}, createClientHydrate);\n    }\n    resolve() {\n      this.middleware({render: RenderToken}, createClientRenderer);\n      return super.resolve();\n    }\n    callback() {\n      this.resolve();\n      const middleware = compose(this.plugins);\n      return () => {\n        // TODO(#62): Create noop context object to match server api\n        const ctx = {\n          url: window.location.path + window.location.search,\n          element: null,\n          body: null,\n        };\n        // $FlowFixMe\n        return middleware(ctx, () => Promise.resolve()).then(() => ctx);\n      };\n    }\n  };\n}\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nexport function assetUrl(url: string): string {\n  /**\n   * PLEASE NOTE: a build step transforms\n   * the arguments provided to this function\n   */\n  return url;\n}\n\nexport function chunkId(filename: string): string {\n  /**\n   * PLEASE NOTE: a build step transforms\n   * the arguments provided to this function\n   */\n  return filename;\n}\n\nexport function syncChunkIds(argument: any): any {\n  /**\n   * PLEASE NOTE: a build step transforms\n   * the arguments provided to this function\n   */\n  return argument;\n}\n\nexport function syncChunkPaths(argument: any): any {\n  /**\n   * PLEASE NOTE: a build step transforms\n   * the arguments provided to this function\n   */\n  return argument;\n}\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\nimport type {Context, FusionPlugin, Middleware, Token} from './types.js';\n\nimport BaseApp from './base-app';\nimport serverApp from './server-app';\nimport clientApp from './client-app';\nimport getEnv from './get-env.js';\n\nexport default (__BROWSER__ ? clientApp() : serverApp());\n\nexport {compose} from './compose.js';\nexport {memoize} from './memoize';\n\n// sanitization API\nexport {\n  html,\n  dangerouslySetHTML,\n  consumeSanitizedHTML,\n  escape,\n  unescape,\n} from './sanitization';\n\n// Virtual modules\nexport {\n  assetUrl,\n  chunkId,\n  syncChunkIds,\n  syncChunkPaths,\n} from './virtual/index.js';\n\nexport {\n  RenderToken,\n  ElementToken,\n  SSRDeciderToken,\n  HttpServerToken,\n} from './tokens';\nexport {createPlugin} from './create-plugin';\nexport {createToken} from './create-token';\nexport {getEnv};\n\ntype FusionApp = typeof BaseApp;\ndeclare export default typeof BaseApp;\nexport type {Context, FusionApp, FusionPlugin, Middleware, Token};\n"],"names":["createPlugin","opts","TokenType","Ref","TokenImpl","name","ref","type","Optional","Required","optional","createToken","RenderToken","ElementToken","SSRDeciderToken","HttpServerToken","html","dangerouslySetHTML","consumeSanitizedHTML","escape","forbiddenChars","replaceForbidden","c","key","Symbol","head","rest","values","obj","defineProperty","map","s","i","join","str","String","replace","h","Error","replaceEscaped","fromCodePoint","parseInt","slice","unescape","flowHtml","flowDangerouslySetHTML","flowConsumeSanitizedHTML","flowEscape","SSRDecider","ctx","path","match","headers","accept","includes","createSSRPlugin","ssrPlugin","next","ssrDecider","template","element","rendered","body","respond","safeAttrs","Object","keys","htmlAttrs","attrKey","safeBodyAttrs","bodyAttrs","safeTitle","title","safeHead","safeBody","preloadHintLinks","getPreloadHintLinks","coreGlobals","getCoreGlobals","chunkScripts","getChunkScripts","bundleSplittingBootstrap","chunkPreloaderScript","getChunkPreloaderScript","chunkManifest","from","chunkUrlMap","entries","forEach","id","variant","filepath","get","basename","serializedManifest","JSON","stringify","hasManifest","length","manifest","nonce","prefix","webpackPublicPath","getUrls","chunks","url","endsWith","crossOrigin","startsWith","sync","syncChunks","preloaded","preloadChunks","hints","trim","FusionApp","el","render","registered","Map","enhancerToToken","plugins","cleanups","register","token","value","__plugin__","undefined","renderer","_register","push","getTokenRef","set","alias","sourceToken","destToken","aliases","deps","middleware","enhancer","enhancers","Array","isArray","Promise","all","fn","resolved","dependedOn","Set","nonPluginTokens","resolving","resolvedPlugins","allAliases","appliedEnhancers","resolveToken","tokenAliases","has","newToken","add","dependents","findDependentTokens","filter","entry","findDependentEnhancers","provides","enhancedToken","dependentTokens","resolvePlugin","plugin","registeredDeps","resolvedDeps","registeredToken","cleanup","resolve","e","nextProvides","delete","aliasPair","sourceTokenRef","destTokenRef","compose","TypeError","context","index","dispatch","reject","err","memoize","memoizeKey","memoized","result","Timing","start","now","deferred","end","downstream","upstream","upstreamStart","timing","TimingToken","promise","then","upstreamTime","endTime","seconds","ns","process","hrtime","Math","round","res","rej","getRendererPlugin","timer","renderTime","renderStart","loadEnv","load","env","rootDir","baseAssetPath","cdnUrl","assetPath","envVars","getEnv","uuidv4","useragent","UAParser","getResult","Koa","require","ServerApp","BaseApp","_app","contextMiddleware","serverRenderer","use","callback","assetUrl","chunkId","filename","syncChunkIds","argument","syncChunkPaths","serverApp"],"mappings":"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"}