{"version":3,"file":"browser.es2017.es.js","sources":["../src/create-plugin.js","../src/create-token.js","../src/tokens.js","../src/sanitization.js","../src/plugins/ssr.js","../src/base-app.js","../src/compose.js","../src/memoize.js","../src/plugins/timing.js","../src/plugins/server-renderer.js","../src/get-env.js","../src/plugins/server-context.js","../src/server-app.js","../src/plugins/client-hydrate.js","../src/plugins/client-renderer.js","../src/client-app.js","../src/virtual/index.js","../src/index.js"],"sourcesContent":["/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport type {FusionPlugin} from './types.js';\n\n// eslint-disable-next-line flowtype/generic-spacing\ntype FusionPluginNoHidden<TDeps, TService> = $Diff<\n  FusionPlugin<TDeps, TService>,\n  {__plugin__: boolean}\n>;\n\nexport function createPlugin<TDeps, TService>(\n  opts: $Exact<FusionPluginNoHidden<TDeps, TService>>\n): FusionPlugin<TDeps, TService> {\n  return {\n    __plugin__: true,\n    ...opts,\n  };\n}\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport type {Token} from './types.js';\n\nexport const TokenType = {\n  Required: 0,\n  Optional: 1,\n};\nfunction Ref() {}\nexport class TokenImpl<TResolved> {\n  name: string;\n  ref: mixed;\n  type: $Values<typeof TokenType>;\n  optional: ?TokenImpl<TResolved>;\n\n  constructor(name: string, ref: mixed) {\n    this.name = name;\n    this.ref = ref || new Ref();\n    this.type = ref ? TokenType.Optional : TokenType.Required;\n    if (!ref) {\n      this.optional = new TokenImpl(name, this.ref);\n    }\n  }\n}\n\nexport function createToken<TResolvedType>(name: string): Token<TResolvedType> {\n  // $FlowFixMe\n  return new TokenImpl(name);\n}\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport {createToken} from './create-token';\nimport type {SSRDecider, Token} from './types.js';\n\nexport const RenderToken = createToken('RenderToken');\nexport const ElementToken = createToken('ElementToken');\nexport const SSRDeciderToken: Token<SSRDecider> = createToken(\n  'SSRDeciderToken'\n);\nexport const HttpServerToken = createToken('HttpServerToken');\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n/*\nWe never want developers to be able to write `ctx.template.body.push(`<div>${stuff}</div>`)`\nbecause that allows XSS attacks by default (e.g. if stuff === '<script>alert(1)</script>')\nInstead, they should use html`<div>{stuff}</div>` so interpolated data gets automatically escaped\nWe trust the markup outside of interpolation because it's code written by a developer with commit permissions,\nwhich can be audited via code reviews\n*/\n\nimport type {SanitizedHTMLWrapper} from './types.js';\n\n// eslint-disable-next-line import/no-mutable-exports\nlet html, dangerouslySetHTML, consumeSanitizedHTML, escape;\nif (__NODE__) {\n  const forbiddenChars = {\n    '<': '\\\\u003C',\n    '>': '\\\\u003E',\n    '\"': '\\\\u0022',\n    '/': '\\\\u002F',\n    '\\u2028': '\\\\u2028',\n    '\\u2029': '\\\\u2029',\n  };\n  const replaceForbidden = c => forbiddenChars[c];\n\n  const key = Symbol('sanitized html');\n  html = (\n    [head, ...rest]: Array<string>,\n    ...values: Array<string>\n  ): SanitizedHTMLWrapper => {\n    const obj = {};\n    Object.defineProperty(obj, key, {\n      enumerable: false,\n      configurable: false,\n      value: head + values.map((s, i) => escape(s) + rest[i]).join(''),\n    });\n    return obj;\n  };\n  dangerouslySetHTML = (str: string): Object => html([str]);\n  escape = (str: any): string => {\n    if (str && str[key]) return consumeSanitizedHTML(str);\n    return String(str).replace(/[<>\"/\\u2028\\u2029]/g, replaceForbidden);\n  };\n  consumeSanitizedHTML = (h: SanitizedHTMLWrapper): string => {\n    if (typeof h === 'string') {\n      throw new Error(`Unsanitized html. Use html\\`${h}\\``);\n    }\n    return h[key];\n  };\n}\nconst replaceEscaped = c => String.fromCodePoint(parseInt(c.slice(2), 16));\nconst unescape = (str: string): string => {\n  return str.replace(\n    /\\\\u003C|\\\\u003E|\\\\u0022|\\\\u002F|\\\\u2028|\\\\u2029/g,\n    replaceEscaped\n  );\n};\n\n// These types are necessary due to not having an assignment in the __BROWSER__ environment\nconst flowHtml = ((html: any): (\n  strings: Array<string>,\n  ...expressions: Array<string>\n) => SanitizedHTMLWrapper);\n\nconst flowDangerouslySetHTML = ((dangerouslySetHTML: any): (\n  html: string\n) => Object);\n\nconst flowConsumeSanitizedHTML = ((consumeSanitizedHTML: any): (\n  str: SanitizedHTMLWrapper\n) => string);\n\nconst flowEscape = ((escape: any): (str: string) => string);\n\nexport {\n  flowHtml as html,\n  flowDangerouslySetHTML as dangerouslySetHTML,\n  flowConsumeSanitizedHTML as consumeSanitizedHTML,\n  flowEscape as escape,\n  unescape,\n};\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport path from 'path';\nimport {createPlugin} from '../create-plugin';\nimport {escape, consumeSanitizedHTML} from '../sanitization';\nimport type {Context, SSRDecider as SSRDeciderService} from '../types.js';\n\nconst SSRDecider = createPlugin({\n  provides: () => {\n    return ctx => {\n      // If the request has one of these extensions, we assume it's not something that requires server-side rendering of virtual dom\n      // TODO(#46): this check should probably look at the asset manifest to ensure asset 404s are handled correctly\n      if (ctx.path.match(/\\.(js|gif|jpg|png|pdf|json)$/)) return false;\n      // The Accept header is a good proxy for whether SSR should happen\n      // Requesting an HTML page via the browser url bar generates a request with `text/html` in its Accept headers\n      // XHR/fetch requests do not have `text/html` in the Accept headers\n      if (!ctx.headers.accept) return false;\n      if (!ctx.headers.accept.includes('text/html')) return false;\n      return true;\n    };\n  },\n});\nexport {SSRDecider};\n\nexport default function createSSRPlugin({\n  element,\n  ssrDecider,\n}: {\n  element: any,\n  ssrDecider: SSRDeciderService,\n}) {\n  return async function ssrPlugin(ctx: Context, next: () => Promise<void>) {\n    if (!ssrDecider(ctx)) return next();\n\n    const template = {\n      htmlAttrs: {},\n      bodyAttrs: {},\n      title: '',\n      head: [],\n      body: [],\n    };\n    ctx.element = element;\n    ctx.rendered = '';\n    ctx.template = template;\n    ctx.type = 'text/html';\n\n    await next();\n\n    // Allow someone to override the ssr by setting ctx.body\n    // This is especially useful for things like ctx.redirect\n    if (ctx.body && ctx.respond !== false) {\n      return;\n    }\n\n    const {htmlAttrs, bodyAttrs, title, head, body} = ctx.template;\n    const safeAttrs = Object.keys(htmlAttrs)\n      .map(attrKey => {\n        return ` ${escape(attrKey)}=\"${escape(htmlAttrs[attrKey])}\"`;\n      })\n      .join('');\n\n    const safeBodyAttrs = Object.keys(bodyAttrs)\n      .map(attrKey => {\n        return ` ${escape(attrKey)}=\"${escape(bodyAttrs[attrKey])}\"`;\n      })\n      .join('');\n\n    const safeTitle = escape(title);\n    // $FlowFixMe\n    const safeHead = head.map(consumeSanitizedHTML).join('');\n    // $FlowFixMe\n    const safeBody = body.map(consumeSanitizedHTML).join('');\n\n    const preloadHintLinks = getPreloadHintLinks(ctx);\n    const coreGlobals = getCoreGlobals(ctx);\n    const chunkScripts = getChunkScripts(ctx);\n    const bundleSplittingBootstrap = [\n      preloadHintLinks,\n      coreGlobals,\n      chunkScripts,\n    ].join('');\n\n    const chunkPreloaderScript = getChunkPreloaderScript(ctx);\n\n    ctx.body = [\n      '<!doctype html>',\n      `<html${safeAttrs}>`,\n      `<head>`,\n      `<meta charset=\"utf-8\" />`,\n      `<title>${safeTitle}</title>`,\n      `${bundleSplittingBootstrap}${safeHead}`,\n      `</head>`,\n      `<body${safeBodyAttrs}>${\n        ctx.rendered\n      }${safeBody}${chunkPreloaderScript}</body>`,\n      '</html>',\n    ].join('');\n  };\n}\n\nfunction getCoreGlobals(ctx) {\n  const {chunkUrlMap, webpackPublicPath, nonce} = ctx;\n\n  const chunkManifest = {};\n  Array.from(chunkUrlMap.entries()).forEach(([id, variant]) => {\n    if (variant) {\n      const filepath = /*variant.get(ctx.esVersion) || */ variant.get('es5');\n      chunkManifest[id] = path.basename(filepath);\n    }\n  }, {});\n  const serializedManifest = JSON.stringify(chunkManifest);\n  const hasManifest = Object.keys(chunkManifest).length > 0;\n  const manifest = hasManifest ? `__MANIFEST__ = ${serializedManifest};` : ''; // consumed by webpack\n\n  return [\n    `<script nonce=\"${nonce}\">`,\n    `window.performance && window.performance.mark && window.performance.mark('firstRenderStart');`,\n    `__ROUTE_PREFIX__ = ${JSON.stringify(ctx.prefix)};`, // consumed by ./client\n    `__WEBPACK_PUBLIC_PATH__ = ${JSON.stringify(webpackPublicPath)};`, // consumed by fusion-clientries/client-entry\n    manifest,\n    `</script>`,\n  ].join('');\n}\n\nfunction getUrls({chunkUrlMap, webpackPublicPath}, chunks) {\n  return chunks.map(id => {\n    let url = chunkUrlMap.get(id).get('es5');\n    if (webpackPublicPath.endsWith('/')) {\n      url = webpackPublicPath + url;\n    } else {\n      url = webpackPublicPath + '/' + url;\n    }\n    return {id, url};\n  });\n}\n\nfunction getChunkScripts(ctx) {\n  const webpackPublicPath = ctx.webpackPublicPath || '';\n  // cross origin is needed to get meaningful errors in window.onerror\n  const crossOrigin = webpackPublicPath.startsWith('https://')\n    ? ' crossorigin=\"anonymous\"'\n    : '';\n  const sync = getUrls(ctx, ctx.syncChunks).map(({url}) => {\n    return `<script defer${crossOrigin} src=\"${url}\"></script>`;\n  });\n  const preloaded = getUrls(ctx, ctx.preloadChunks).map(({id, url}) => {\n    return `<script defer${crossOrigin} src=\"${url}\" data-webpack-preload=\"${id}\"></script>`;\n  });\n  return [...preloaded, ...sync].join('');\n}\n\nfunction getPreloadHintLinks(ctx) {\n  const chunks = [...ctx.preloadChunks, ...ctx.syncChunks];\n  const hints = getUrls(ctx, chunks).map(({url}) => {\n    return `<link rel=\"preload\" href=\"${url}\" as=\"script\" />`;\n  });\n  return hints.join('');\n}\n\nfunction getChunkPreloaderScript({nonce = '', preloadChunks}) {\n  // NOTE: the event listeners below are not needed if inline onerror event handlers are allowed by CSP.\n  // However, this is disallowed currently.\n  return trim(`\n  <script nonce=\"${nonce}\">\n  (function(){\n    __PRELOADED_CHUNKS__ = ${JSON.stringify(preloadChunks)};\n    function onError(e) {\n      var el = e.target;\n      if (el.nodeName !== \"SCRIPT\") return;\n      var val = el.getAttribute(\"data-webpack-preload\");\n      if (val === null) return;\n      var id = parseInt(val, 10);\n      if (__HANDLE_ERROR) return __HANDLE_ERROR(id);\n      if (!__UNHANDLED_ERRORS__) __UNHANDLED_ERRORS__ = [];\n      __UNHANDLED_ERRORS__.push(id);\n    }\n    addEventListener(\"error\", onError, true);\n    addEventListener(\"load\", function() {\n        removeEventListener(\"error\", onError);\n    });\n  })();\n  </script>`);\n}\n\nfunction trim(str) {\n  return str.replace(/^\\s+/gm, '');\n}\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport {createPlugin} from './create-plugin';\nimport {createToken, TokenType, TokenImpl} from './create-token';\nimport {ElementToken, RenderToken, SSRDeciderToken} from './tokens';\nimport {SSRDecider} from './plugins/ssr';\n\nimport type {aliaser, cleanupFn, FusionPlugin, Token} from './types.js';\n\nclass FusionApp {\n  constructor(el: Element | string, render: *) {\n    this.registered = new Map(); // getTokenRef(token) -> {value, aliases, enhancers}\n    this.enhancerToToken = new Map(); // enhancer -> token\n    this.plugins = []; // Token\n    this.cleanups = [];\n    el && this.register(ElementToken, el);\n    render && this.register(RenderToken, render);\n    this.register(SSRDeciderToken, SSRDecider);\n  }\n\n  // eslint-disable-next-line\n  registered: Map<\n    any,\n    {\n      aliases?: Map<any, any>,\n      enhancers?: Array<any>,\n      token: any,\n      value?: FusionPlugin<*, *>,\n    }\n  >;\n  enhancerToToken: Map<any, any>;\n  plugins: Array<any>;\n  cleanups: Array<cleanupFn>;\n  renderer: any;\n\n  register(token: *, value: *): aliaser<*> {\n    // $FlowFixMe\n    if (token && token.__plugin__) {\n      value = token;\n      token = createToken('UnnamedPlugin');\n    }\n    if (!(token instanceof TokenImpl) && value === undefined) {\n      throw new Error(\n        __DEV__\n          ? `Cannot register ${String(\n              token\n            )} without a token. Did you accidentally register a ${\n              __NODE__ ? 'browser' : 'server'\n            } plugin on the ${__NODE__ ? 'server' : 'browser'}?`\n          : 'Invalid configuration registration'\n      );\n    }\n    // the renderer is a special case, since it needs to be always run last\n    if (token === RenderToken) {\n      this.renderer = value;\n      return {\n        alias: () => {\n          throw new Error('Aliasing for RenderToken not supported.');\n        },\n      };\n    }\n    return this._register(token, value);\n  }\n  _register<TResolved>(token: Token<TResolved>, value: *) {\n    this.plugins.push(token);\n    const {aliases, enhancers} = this.registered.get(getTokenRef(token)) || {\n      aliases: new Map(),\n      enhancers: [],\n    };\n    this.registered.set(getTokenRef(token), {value, aliases, enhancers, token});\n    function alias(sourceToken: *, destToken: *) {\n      if (aliases) {\n        aliases.set(sourceToken, destToken);\n      }\n      return {alias};\n    }\n    return {alias};\n  }\n  middleware(deps: *, middleware: *) {\n    if (middleware === undefined) {\n      middleware = () => deps;\n    }\n    this.register(createPlugin({deps, middleware}));\n  }\n  enhance<TResolved>(token: Token<TResolved>, enhancer: Function) {\n    const {value, aliases, enhancers} = this.registered.get(\n      getTokenRef(token)\n    ) || {\n      aliases: new Map(),\n      enhancers: [],\n      value: undefined,\n    };\n    this.enhancerToToken.set(enhancer, token);\n\n    if (enhancers && Array.isArray(enhancers)) {\n      enhancers.push(enhancer);\n    }\n    this.registered.set(getTokenRef(token), {value, aliases, enhancers, token});\n  }\n  cleanup() {\n    return Promise.all(this.cleanups.map(fn => fn()));\n  }\n  resolve<TResolved>() {\n    if (!this.renderer) {\n      throw new Error('Missing registration for RenderToken');\n    }\n    this._register(RenderToken, this.renderer);\n    const resolved = new Map(); // Token.ref || Token => Service\n    const dependedOn = new Set(); // Token.ref || Token\n    const nonPluginTokens = new Set(); // Token\n    const resolving = new Set(); // Token.ref || Token\n    const registered = this.registered; // Token.ref || Token -> {value, aliases, enhancers}\n    const resolvedPlugins = []; // Plugins\n    const allAliases = new Set(); // Token.ref || Token\n    const appliedEnhancers = [];\n    const resolveToken = (token: Token<TResolved>, tokenAliases) => {\n      // Base: if we have already resolved the type, return it\n      if (tokenAliases && tokenAliases.has(token)) {\n        const newToken = tokenAliases.get(token);\n        allAliases.add([getTokenRef(token), getTokenRef(newToken)]);\n        if (newToken) {\n          token = newToken;\n        }\n      }\n      if (resolved.has(getTokenRef(token))) {\n        return resolved.get(getTokenRef(token));\n      }\n\n      // Base: if currently resolving the same type, we have a circular dependency\n      if (resolving.has(getTokenRef(token))) {\n        throw new Error(`Cannot resolve circular dependency: ${token.name}`);\n      }\n\n      // Base: the type was never registered, throw error or provide undefined if optional\n      let {value, aliases, enhancers} =\n        registered.get(getTokenRef(token)) || {};\n      if (value === undefined) {\n        // Attempt to get default value, if optional\n        if (token instanceof TokenImpl && token.type === TokenType.Optional) {\n          this.register(token, undefined);\n        } else {\n          const dependents = Array.from(this.registered.entries());\n\n          /**\n           * Iterate over the entire list of dependencies and find all\n           * dependencies of a given token.\n           */\n          const findDependentTokens = () => {\n            return dependents\n              .filter(entry => {\n                if (!entry[1].value || !entry[1].value.deps) {\n                  return false;\n                }\n                return Object.values(entry[1].value.deps).includes(token);\n              })\n              .map(entry => entry[1].token.name);\n          };\n          const findDependentEnhancers = () => {\n            return appliedEnhancers\n              .filter(([, provides]) => {\n                if (!provides || !provides.deps) {\n                  return false;\n                }\n                return Object.values(provides.deps).includes(token);\n              })\n              .map(([enhancer]) => {\n                const enhancedToken = this.enhancerToToken.get(enhancer);\n                return `EnhancerOf<${\n                  enhancedToken ? enhancedToken.name : '(unknown)'\n                }>`;\n              });\n          };\n          const dependentTokens = [\n            ...findDependentTokens(),\n            ...findDependentEnhancers(),\n          ];\n\n          // otherwise, we cannot resolve this token\n          throw new Error(\n            `Could not resolve token: \"${\n              token ? token.name : '(unknown)'\n            }\", which is required by plugins registered with tokens: ${dependentTokens\n              .map(token => `\"${token}\"`)\n              .join(', ')}. Did you forget to register a value for \"${\n              token ? token.name : '(unknown)'\n            }\"?`\n          );\n        }\n      }\n\n      // Recursive: get the registered type and resolve it\n      resolving.add(getTokenRef(token));\n\n      function resolvePlugin(plugin) {\n        const registeredDeps = (plugin && plugin.deps) || {};\n        const resolvedDeps = {};\n        for (const key in registeredDeps) {\n          const registeredToken = registeredDeps[key];\n          dependedOn.add(getTokenRef(registeredToken));\n          resolvedDeps[key] = resolveToken(registeredToken, aliases);\n        }\n        // `provides` should be undefined if the plugin does not have a `provides` function\n        let provides =\n          plugin && plugin.provides ? plugin.provides(resolvedDeps) : undefined;\n        if (plugin && plugin.middleware) {\n          resolvedPlugins.push(plugin.middleware(resolvedDeps, provides));\n        }\n        return provides;\n      }\n\n      let provides = value;\n      if (value && value.__plugin__) {\n        provides = resolvePlugin(provides);\n        if (value.cleanup) {\n          this.cleanups.push(function() {\n            return typeof value.cleanup === 'function'\n              ? value.cleanup(provides)\n              : Promise.resolve();\n          });\n        }\n      } else {\n        nonPluginTokens.add(token);\n      }\n\n      if (enhancers && enhancers.length) {\n        enhancers.forEach(e => {\n          let nextProvides = e(provides);\n          appliedEnhancers.push([e, nextProvides]);\n          if (nextProvides && nextProvides.__plugin__) {\n            nextProvides = resolvePlugin(nextProvides);\n          }\n          provides = nextProvides;\n        });\n      }\n      resolved.set(getTokenRef(token), provides);\n      resolving.delete(getTokenRef(token));\n      return provides;\n    };\n\n    for (let i = 0; i < this.plugins.length; i++) {\n      resolveToken(this.plugins[i]);\n    }\n    for (const aliasPair of allAliases) {\n      const [sourceTokenRef, destTokenRef] = aliasPair;\n      if (dependedOn.has(sourceTokenRef)) {\n        dependedOn.add(destTokenRef);\n      }\n    }\n    for (const token of nonPluginTokens) {\n      if (!dependedOn.has(getTokenRef(token))) {\n        throw new Error(\n          `Registered token without depending on it: \"${token.name}\"`\n        );\n      }\n    }\n    this.plugins = resolvedPlugins;\n  }\n}\n\n/* Helper functions */\nfunction getTokenRef(token) {\n  if (token instanceof TokenImpl) {\n    return token.ref;\n  }\n  return token;\n}\n\nexport default FusionApp;\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport type {Middleware} from './types.js';\n\n// inline version of koa-compose to get around Rollup/CUP commonjs-related issue\nexport function compose(middleware: Array<Middleware>): Middleware {\n  if (!Array.isArray(middleware)) {\n    throw new TypeError('Middleware stack must be an array!');\n  }\n  for (const fn of middleware) {\n    if (typeof fn !== 'function') {\n      throw new TypeError(\n        `Expected middleware function, received: ${typeof fn}`\n      );\n    }\n  }\n\n  return function(context, next) {\n    let index = -1;\n    return dispatch(0);\n    function dispatch(i) {\n      if (i <= index) {\n        return Promise.reject(new Error('next() called multiple times'));\n      }\n      index = i;\n      let fn = middleware[i];\n      if (i === middleware.length) fn = next;\n      if (!fn) return Promise.resolve();\n      try {\n        // $FlowFixMe\n        return fn(context, function next() {\n          return dispatch(i + 1);\n        });\n      } catch (err) {\n        return Promise.reject(err);\n      }\n    }\n  };\n}\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport type {Context} from './types.js';\n\ntype MemoizeFn<A> = (ctx: Context) => A;\n\nfunction Container() {}\n\nexport function memoize<A>(fn: MemoizeFn<A>): MemoizeFn<A> {\n  const memoizeKey = __NODE__ ? Symbol('memoize-key') : new Container();\n  return function memoized(ctx: Context) {\n    if (ctx.memoized.has(memoizeKey)) {\n      return ctx.memoized.get(memoizeKey);\n    }\n    const result = fn(ctx);\n    ctx.memoized.set(memoizeKey, result);\n    return result;\n  };\n}\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\nimport {createPlugin} from '../create-plugin';\nimport {memoize} from '../memoize';\nimport {createToken} from '../create-token';\nimport type {Token} from '../types.js';\n\ntype Deferred<T> = {\n  promise: Promise<T>,\n  resolve: (result: T) => void,\n  reject: (error: Error) => void,\n};\n\nclass Timing {\n  start: number;\n  render: Deferred<number>;\n  end: Deferred<number>;\n  downstream: Deferred<number>;\n  upstream: Deferred<number>;\n  upstreamStart: number;\n  constructor() {\n    this.start = now();\n    this.render = deferred();\n    this.end = deferred();\n    this.downstream = deferred();\n    this.upstream = deferred();\n    this.upstreamStart = -1;\n  }\n}\ntype TimingPlugin = {\n  from(ctx: Object): Timing,\n};\n\nconst timing: TimingPlugin = {\n  from: memoize(() => new Timing()),\n};\n\nexport const TimingToken: Token<TimingPlugin> = createToken('TimingToken');\n\nfunction middleware(ctx, next) {\n  ctx.memoized = new Map();\n  const {start, render, end, downstream, upstream} = timing.from(ctx);\n  ctx.timing = {\n    start,\n    render: render.promise,\n    end: end.promise,\n    downstream: downstream.promise,\n    upstream: upstream.promise,\n  };\n  return next().then(() => {\n    const upstreamTime = now() - timing.from(ctx).upstreamStart;\n    upstream.resolve(upstreamTime);\n    const endTime = now() - ctx.timing.start;\n    end.resolve(endTime);\n  });\n}\n\nexport default createPlugin({\n  provides: () => timing,\n  middleware: () => middleware,\n});\n\nexport function now(): number {\n  if (__NODE__) {\n    const [seconds, ns] = process.hrtime();\n    return Math.round(seconds * 1000 + ns / 1e6);\n  } else {\n    // eslint-disable-next-line cup/no-undef\n    if (window.performance && window.performance.now) {\n      // eslint-disable-next-line cup/no-undef\n      return Math.round(window.performance.now());\n    }\n    return Date.now();\n  }\n}\n\nfunction deferred<T>(): Deferred<T> {\n  let resolve = () => {};\n  let reject = () => {};\n  const promise = new Promise((res, rej) => {\n    resolve = res;\n    reject = rej;\n  });\n  return {\n    promise,\n    resolve,\n    reject,\n  };\n}\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport {now} from './timing';\n\nimport type {Context} from '../types.js';\n\nexport default function getRendererPlugin({\n  render,\n  timing,\n}: {\n  render: any,\n  timing: any,\n}) {\n  return async function renderer(ctx: Context, next: () => Promise<void>) {\n    const timer = timing.from(ctx);\n    timer.downstream.resolve(now() - timer.start);\n\n    let renderTime = null;\n    if (ctx.element && !ctx.body && ctx.respond !== false) {\n      const renderStart = now();\n      ctx.rendered = await render(ctx.element);\n      renderTime = now() - renderStart;\n    }\n\n    timer.upstreamStart = now();\n    await next();\n\n    if (ctx.element && typeof renderTime === 'number') {\n      timer.render.resolve(renderTime);\n    }\n  };\n}\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n/* eslint-env node */\nimport assert from 'assert';\n\nexport default (__BROWSER__ ? () => {} : loadEnv());\n\nfunction load(key, value) {\n  return process.env[key] || value;\n}\n\nexport function loadEnv() {\n  const rootDir = load('ROOT_DIR', '.');\n  const env = load('NODE_ENV', 'development');\n  if (!(env === 'development' || env === 'production' || env === 'test')) {\n    throw new Error(`Invalid NODE_ENV loaded: ${env}.`);\n  }\n  const prefix = load('ROUTE_PREFIX', '');\n  assert(!prefix.endsWith('/'), 'ROUTE_PREFIX must not end with /');\n  const baseAssetPath = load('FRAMEWORK_STATIC_ASSET_PATH', `/_static`);\n  assert(\n    !baseAssetPath.endsWith('/'),\n    'FRAMEWORK_STATIC_ASSET_PATH must not end with /'\n  );\n  const cdnUrl = load('CDN_URL', '');\n  assert(!cdnUrl.endsWith('/'), 'CDN_URL must not end with /');\n\n  const assetPath = `${prefix}${baseAssetPath}`;\n  return function loadEnv(): Env {\n    return {\n      rootDir,\n      env,\n      prefix,\n      assetPath,\n      baseAssetPath,\n      cdnUrl,\n      webpackPublicPath: cdnUrl || assetPath,\n    };\n  };\n}\n\n// Handle flow-types for export so browser export is ignored.\ntype Env = {\n  rootDir: string,\n  env: string,\n  prefix: string,\n  assetPath: string,\n  baseAssetPath: string,\n  cdnUrl: string,\n  webpackPublicPath: string,\n};\ndeclare export default () => Env;\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport uuidv4 from 'uuid/v4';\nimport UAParser from 'ua-parser-js';\nimport getEnv from '../get-env.js';\n\nimport type {Context} from '../types.js';\n\nconst envVars = getEnv();\n\nexport default function middleware(ctx: Context, next: () => Promise<void>) {\n  // env vars\n  ctx.rootDir = envVars.rootDir;\n  ctx.env = envVars.env;\n  ctx.prefix = envVars.prefix;\n  ctx.assetPath = envVars.assetPath;\n  ctx.cdnUrl = envVars.cdnUrl;\n\n  // webpack-related things\n  ctx.preloadChunks = [];\n  ctx.webpackPublicPath =\n    ctx.webpackPublicPath || envVars.cdnUrl || envVars.assetPath;\n\n  // these are set by fusion-cli, however since fusion-cli plugins are not added when\n  // running simulation tests, it is good to default them here\n  ctx.syncChunks = ctx.syncChunks || [];\n  ctx.chunkUrlMap = ctx.chunkUrlMap || new Map();\n\n  // fusion-specific things\n  ctx.nonce = uuidv4();\n  ctx.useragent = new UAParser(ctx.headers['user-agent']).getResult();\n  ctx.element = null;\n  ctx.rendered = null;\n\n  return next();\n}\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n/* eslint-env node */\nimport {compose} from './compose.js';\nimport Timing, {TimingToken} from './plugins/timing';\nimport BaseApp from './base-app';\nimport serverRenderer from './plugins/server-renderer';\nimport {RenderToken, ElementToken, SSRDeciderToken} from './tokens';\nimport ssrPlugin from './plugins/ssr';\nimport contextMiddleware from './plugins/server-context.js';\n\nexport default function(): typeof BaseApp {\n  const Koa = require('koa');\n\n  return class ServerApp extends BaseApp {\n    _app: Koa;\n    constructor(el, render) {\n      super(el, render);\n      this._app = new Koa();\n      this.middleware(contextMiddleware);\n      this.register(TimingToken, Timing);\n      this.middleware(\n        {element: ElementToken, ssrDecider: SSRDeciderToken},\n        ssrPlugin\n      );\n    }\n    resolve() {\n      this.middleware(\n        {timing: TimingToken, render: RenderToken},\n        serverRenderer\n      );\n      return super.resolve();\n    }\n    callback() {\n      this.resolve();\n      this._app.use(compose(this.plugins));\n      return this._app.callback();\n    }\n  };\n}\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\n/* eslint-env browser */\n\nimport type {Context} from '../types.js';\n\nexport default function createClientHydrate({element}: {element: any}) {\n  return function clientHydrate(ctx: Context, next: () => Promise<void>) {\n    ctx.prefix = window.__ROUTE_PREFIX__ || ''; // serialized by ./server\n    ctx.element = element;\n    ctx.preloadChunks = [];\n    return next();\n  };\n}\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport type {Context} from '../types.js';\n\nexport default function createClientRenderer({render}: {render: any}) {\n  return function renderer(ctx: Context, next: () => Promise<void>) {\n    const rendered = render(ctx.element);\n    if (rendered instanceof Promise) {\n      return rendered.then(r => {\n        ctx.rendered = r;\n        return next();\n      });\n    } else {\n      ctx.rendered = rendered;\n      return next();\n    }\n  };\n}\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n/* eslint-env browser */\nimport {compose} from './compose.js';\nimport timing, {TimingToken} from './plugins/timing';\nimport BaseApp from './base-app';\nimport createClientHydrate from './plugins/client-hydrate';\nimport createClientRenderer from './plugins/client-renderer';\nimport {RenderToken, ElementToken} from './tokens';\n\nexport default function(): typeof BaseApp {\n  return class ClientApp extends BaseApp {\n    constructor(el, render) {\n      super(el, render);\n      this.register(TimingToken, timing);\n      this.middleware({element: ElementToken}, createClientHydrate);\n    }\n    resolve() {\n      this.middleware({render: RenderToken}, createClientRenderer);\n      return super.resolve();\n    }\n    callback() {\n      this.resolve();\n      const middleware = compose(this.plugins);\n      return () => {\n        // TODO(#62): Create noop context object to match server api\n        const ctx = {\n          url: window.location.path + window.location.search,\n          element: null,\n          body: null,\n        };\n        // $FlowFixMe\n        return middleware(ctx, () => Promise.resolve()).then(() => ctx);\n      };\n    }\n  };\n}\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nexport function assetUrl(url: string): string {\n  /**\n   * PLEASE NOTE: a build step transforms\n   * the arguments provided to this function\n   */\n  return url;\n}\n\nexport function chunkId(filename: string): string {\n  /**\n   * PLEASE NOTE: a build step transforms\n   * the arguments provided to this function\n   */\n  return filename;\n}\n\nexport function syncChunkIds(argument: any): any {\n  /**\n   * PLEASE NOTE: a build step transforms\n   * the arguments provided to this function\n   */\n  return argument;\n}\n\nexport function syncChunkPaths(argument: any): any {\n  /**\n   * PLEASE NOTE: a build step transforms\n   * the arguments provided to this function\n   */\n  return argument;\n}\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\nimport type {Context, FusionPlugin, Middleware, Token} from './types.js';\n\nimport BaseApp from './base-app';\nimport serverApp from './server-app';\nimport clientApp from './client-app';\nimport getEnv from './get-env.js';\n\nexport default (__BROWSER__ ? clientApp() : serverApp());\n\nexport {compose} from './compose.js';\nexport {memoize} from './memoize';\n\n// sanitization API\nexport {\n  html,\n  dangerouslySetHTML,\n  consumeSanitizedHTML,\n  escape,\n  unescape,\n} from './sanitization';\n\n// Virtual modules\nexport {\n  assetUrl,\n  chunkId,\n  syncChunkIds,\n  syncChunkPaths,\n} from './virtual/index.js';\n\nexport {\n  RenderToken,\n  ElementToken,\n  SSRDeciderToken,\n  HttpServerToken,\n} from './tokens';\nexport {createPlugin} from './create-plugin';\nexport {createToken} from './create-token';\nexport {getEnv};\n\ntype FusionApp = typeof BaseApp;\ndeclare export default typeof BaseApp;\nexport type {Context, FusionApp, FusionPlugin, Middleware, Token};\n"],"names":["createPlugin","opts","TokenType","Ref","TokenImpl","name","ref","type","Optional","Required","optional","createToken","RenderToken","ElementToken","SSRDeciderToken","HttpServerToken","html","dangerouslySetHTML","consumeSanitizedHTML","escape","replaceEscaped","c","String","fromCodePoint","parseInt","slice","unescape","str","replace","flowHtml","flowDangerouslySetHTML","flowConsumeSanitizedHTML","flowEscape","SSRDecider","ctx","path","match","headers","accept","includes","FusionApp","el","render","registered","Map","enhancerToToken","plugins","cleanups","register","token","value","__plugin__","undefined","Error","renderer","_register","push","get","getTokenRef","set","alias","sourceToken","destToken","aliases","deps","middleware","enhancer","enhancers","Array","isArray","Promise","all","map","fn","resolved","dependedOn","Set","nonPluginTokens","resolving","resolvedPlugins","allAliases","appliedEnhancers","resolveToken","tokenAliases","has","newToken","add","dependents","from","entries","findDependentTokens","filter","entry","Object","values","findDependentEnhancers","provides","enhancedToken","dependentTokens","join","resolvePlugin","plugin","registeredDeps","resolvedDeps","key","registeredToken","cleanup","resolve","length","forEach","e","nextProvides","delete","i","aliasPair","sourceTokenRef","destTokenRef","compose","TypeError","context","next","index","dispatch","reject","err","Container","memoize","memoizeKey","memoized","result","Timing","start","now","deferred","end","downstream","upstream","upstreamStart","timing","TimingToken","promise","then","upstreamTime","endTime","window","performance","Math","round","Date","res","rej","createClientHydrate","clientHydrate","prefix","__ROUTE_PREFIX__","element","preloadChunks","createClientRenderer","rendered","r","ClientApp","BaseApp","location","search","assetUrl","url","chunkId","filename","syncChunkIds","argument","syncChunkPaths","clientApp"],"mappings":"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"}