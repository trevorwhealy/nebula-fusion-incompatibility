{"version":3,"sources":["../../../src/text-layer/font-atlas.js"],"names":["GL_TEXTURE_WRAP_S","GL_TEXTURE_WRAP_T","GL_CLAMP_TO_EDGE","MAX_CANVAS_WIDTH","DEFAULT_FONT_SIZE","DEFAULT_PADDING","BASELINE_SCALE","HEIGHT_SCALE","DEFAULT_CHAR_SET","i","push","String","fromCharCode","setTextStyle","ctx","fontFamily","fontSize","font","fillStyle","textBaseline","textAlign","makeFontAtlas","gl","characterSet","padding","canvas","document","createElement","getContext","row","x","fontHeight","mapping","Array","from","forEach","measureText","char","width","y","height","mask","fillText","scale","texture","Texture2D","pixels","parameters"],"mappings":";;;;;;;;AACA;;;;AAEA,IAAMA,oBAAoB,MAA1B;AACA,IAAMC,oBAAoB,MAA1B;AACA,IAAMC,mBAAmB,MAAzB;AACA,IAAMC,mBAAmB,IAAzB;AACA,IAAMC,oBAAoB,EAA1B;AACA,IAAMC,kBAAkB,CAAxB;AAEA,IAAMC,iBAAiB,GAAvB;AACA,IAAMC,eAAe,GAArB;AAEO,IAAMC,mBAAmB,EAAzB;;;AACP,KAAK,IAAIC,IAAI,EAAb,EAAiBA,IAAI,GAArB,EAA0BA,GAA1B,EAA+B;AAC7BD,mBAAiBE,IAAjB,CAAsBC,OAAOC,YAAP,CAAoBH,CAApB,CAAtB;AACD;;AAED,SAASI,YAAT,CAAsBC,GAAtB,EAA2BC,UAA3B,EAAuCC,QAAvC,EAAiD;AAC/CF,MAAIG,IAAJ,aAAcD,QAAd,gBAA4BD,UAA5B;AACAD,MAAII,SAAJ,GAAgB,MAAhB;AACAJ,MAAIK,YAAJ,GAAmB,UAAnB;AACAL,MAAIM,SAAJ,GAAgB,MAAhB;AACD;;AAEM,SAASC,aAAT,CACLC,EADK,QAQL;AAAA;;AAAA,MALEP,UAKF,QALEA,UAKF;AAAA,+BAJEQ,YAIF;AAAA,MAJEA,YAIF,kCAJiBf,gBAIjB;AAAA,2BAHEQ,QAGF;AAAA,MAHEA,QAGF,8BAHaZ,iBAGb;AAAA,0BAFEoB,OAEF;AAAA,MAFEA,OAEF,6BAFYnB,eAEZ;AACA,MAAMoB,SAASC,SAASC,aAAT,CAAuB,QAAvB,CAAf;AACA,MAAMb,MAAMW,OAAOG,UAAP,CAAkB,IAAlB,CAAZ,CAFA,CAIA;;AACA,MAAIC,MAAM,CAAV;AACA,MAAIC,IAAI,CAAR,CANA,CAOA;AACA;;AACA,MAAMC,aAAaf,WAAWT,YAA9B;AACAM,eAAaC,GAAb,EAAkBC,UAAlB,EAA8BC,QAA9B;AACA,MAAMgB,UAAU,EAAhB;AAEAC,QAAMC,IAAN,CAAWX,YAAX,EAAyBY,OAAzB,CAAiC,gBAAQ;AAAA,2BACvBrB,IAAIsB,WAAJ,CAAgBC,IAAhB,CADuB;AAAA,QAChCC,KADgC,oBAChCA,KADgC;;AAGvC,QAAIR,IAAIQ,KAAJ,GAAYnC,gBAAhB,EAAkC;AAChC2B,UAAI,CAAJ;AACAD;AACD;;AACDG,YAAQK,IAAR,IAAgB;AACdP,UADc;AAEdS,SAAGV,OAAOE,aAAaP,OAApB,CAFW;AAGdc,kBAHc;AAIdE,cAAQT,UAJM;AAKdU,YAAM;AALQ,KAAhB;AAOAX,SAAKQ,QAAQd,OAAb;AACD,GAfD;AAiBAC,SAAOa,KAAP,GAAenC,gBAAf;AACAsB,SAAOe,MAAP,GAAgB,CAACX,MAAM,CAAP,KAAaE,aAAaP,OAA1B,CAAhB;AAEAX,eAAaC,GAAb,EAAkBC,UAAlB,EAA8BC,QAA9B;;AACA,OAAK,IAAMqB,IAAX,IAAmBL,OAAnB,EAA4B;AAC1BlB,QAAI4B,QAAJ,CAAaL,IAAb,EAAmBL,QAAQK,IAAR,EAAcP,CAAjC,EAAoCE,QAAQK,IAAR,EAAcE,CAAd,GAAkBvB,WAAWV,cAAjE;AACD;;AAED,SAAO;AACLqC,WAAOpC,YADF;AAELyB,oBAFK;AAGLY,aAAS,IAAIC,eAAJ,CAAcvB,EAAd,EAAkB;AACzBwB,cAAQrB,MADiB;AAEzB;AACA;AACAsB,kEACG/C,iBADH,EACuBE,gBADvB,gCAEGD,iBAFH,EAEuBC,gBAFvB;AAJyB,KAAlB;AAHJ,GAAP;AAaD","sourcesContent":["/* global document */\nimport {Texture2D} from 'luma.gl';\n\nconst GL_TEXTURE_WRAP_S = 0x2802;\nconst GL_TEXTURE_WRAP_T = 0x2803;\nconst GL_CLAMP_TO_EDGE = 0x812f;\nconst MAX_CANVAS_WIDTH = 1024;\nconst DEFAULT_FONT_SIZE = 64;\nconst DEFAULT_PADDING = 4;\n\nconst BASELINE_SCALE = 0.9;\nconst HEIGHT_SCALE = 1.2;\n\nexport const DEFAULT_CHAR_SET = [];\nfor (let i = 32; i < 128; i++) {\n  DEFAULT_CHAR_SET.push(String.fromCharCode(i));\n}\n\nfunction setTextStyle(ctx, fontFamily, fontSize) {\n  ctx.font = `${fontSize}px ${fontFamily}`;\n  ctx.fillStyle = '#000';\n  ctx.textBaseline = 'baseline';\n  ctx.textAlign = 'left';\n}\n\nexport function makeFontAtlas(\n  gl,\n  {\n    fontFamily,\n    characterSet = DEFAULT_CHAR_SET,\n    fontSize = DEFAULT_FONT_SIZE,\n    padding = DEFAULT_PADDING\n  }\n) {\n  const canvas = document.createElement('canvas');\n  const ctx = canvas.getContext('2d');\n\n  // measure texts\n  let row = 0;\n  let x = 0;\n  // TODO - use Advanced text metrics when they are adopted:\n  // https://developer.mozilla.org/en-US/docs/Web/API/TextMetrics\n  const fontHeight = fontSize * HEIGHT_SCALE;\n  setTextStyle(ctx, fontFamily, fontSize);\n  const mapping = {};\n\n  Array.from(characterSet).forEach(char => {\n    const {width} = ctx.measureText(char);\n\n    if (x + width > MAX_CANVAS_WIDTH) {\n      x = 0;\n      row++;\n    }\n    mapping[char] = {\n      x,\n      y: row * (fontHeight + padding),\n      width,\n      height: fontHeight,\n      mask: true\n    };\n    x += width + padding;\n  });\n\n  canvas.width = MAX_CANVAS_WIDTH;\n  canvas.height = (row + 1) * (fontHeight + padding);\n\n  setTextStyle(ctx, fontFamily, fontSize);\n  for (const char in mapping) {\n    ctx.fillText(char, mapping[char].x, mapping[char].y + fontSize * BASELINE_SCALE);\n  }\n\n  return {\n    scale: HEIGHT_SCALE,\n    mapping,\n    texture: new Texture2D(gl, {\n      pixels: canvas,\n      // padding is added only between the characters but not for borders\n      // enforce CLAMP_TO_EDGE to avoid any artifacts.\n      parameters: {\n        [GL_TEXTURE_WRAP_S]: GL_CLAMP_TO_EDGE,\n        [GL_TEXTURE_WRAP_T]: GL_CLAMP_TO_EDGE\n      }\n    })\n  };\n}\n"],"file":"font-atlas.js"}