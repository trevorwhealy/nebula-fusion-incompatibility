{"version":3,"sources":["../../../src/text-layer/font-atlas.js"],"names":["Texture2D","GL_TEXTURE_WRAP_S","GL_TEXTURE_WRAP_T","GL_CLAMP_TO_EDGE","MAX_CANVAS_WIDTH","DEFAULT_FONT_SIZE","DEFAULT_PADDING","BASELINE_SCALE","HEIGHT_SCALE","DEFAULT_CHAR_SET","i","push","String","fromCharCode","setTextStyle","ctx","fontFamily","fontSize","font","fillStyle","textBaseline","textAlign","makeFontAtlas","gl","characterSet","padding","canvas","document","createElement","getContext","row","x","fontHeight","mapping","Array","from","forEach","char","measureText","width","y","height","mask","fillText","scale","texture","pixels","parameters"],"mappings":"AAAA;AACA,SAAQA,SAAR,QAAwB,SAAxB;AAEA,MAAMC,oBAAoB,MAA1B;AACA,MAAMC,oBAAoB,MAA1B;AACA,MAAMC,mBAAmB,MAAzB;AACA,MAAMC,mBAAmB,IAAzB;AACA,MAAMC,oBAAoB,EAA1B;AACA,MAAMC,kBAAkB,CAAxB;AAEA,MAAMC,iBAAiB,GAAvB;AACA,MAAMC,eAAe,GAArB;AAEA,OAAO,MAAMC,mBAAmB,EAAzB;;AACP,KAAK,IAAIC,IAAI,EAAb,EAAiBA,IAAI,GAArB,EAA0BA,GAA1B,EAA+B;AAC7BD,mBAAiBE,IAAjB,CAAsBC,OAAOC,YAAP,CAAoBH,CAApB,CAAtB;AACD;;AAED,SAASI,YAAT,CAAsBC,GAAtB,EAA2BC,UAA3B,EAAuCC,QAAvC,EAAiD;AAC/CF,MAAIG,IAAJ,GAAY,GAAED,QAAS,MAAKD,UAAW,EAAvC;AACAD,MAAII,SAAJ,GAAgB,MAAhB;AACAJ,MAAIK,YAAJ,GAAmB,UAAnB;AACAL,MAAIM,SAAJ,GAAgB,MAAhB;AACD;;AAED,OAAO,SAASC,aAAT,CACLC,EADK,EAEL;AACEP,YADF;AAEEQ,iBAAef,gBAFjB;AAGEQ,aAAWZ,iBAHb;AAIEoB,YAAUnB;AAJZ,CAFK,EAQL;AACA,QAAMoB,SAASC,SAASC,aAAT,CAAuB,QAAvB,CAAf;AACA,QAAMb,MAAMW,OAAOG,UAAP,CAAkB,IAAlB,CAAZ,CAFA,CAIA;;AACA,MAAIC,MAAM,CAAV;AACA,MAAIC,IAAI,CAAR,CANA,CAOA;AACA;;AACA,QAAMC,aAAaf,WAAWT,YAA9B;AACAM,eAAaC,GAAb,EAAkBC,UAAlB,EAA8BC,QAA9B;AACA,QAAMgB,UAAU,EAAhB;AAEAC,QAAMC,IAAN,CAAWX,YAAX,EAAyBY,OAAzB,CAAiCC,QAAQ;AAAA,6BACvBtB,IAAIuB,WAAJ,CAAgBD,IAAhB,CADuB;AAAA,UAChCE,KADgC,oBAChCA,KADgC;;AAGvC,QAAIR,IAAIQ,KAAJ,GAAYnC,gBAAhB,EAAkC;AAChC2B,UAAI,CAAJ;AACAD;AACD;;AACDG,YAAQI,IAAR,IAAgB;AACdN,OADc;AAEdS,SAAGV,OAAOE,aAAaP,OAApB,CAFW;AAGdc,WAHc;AAIdE,cAAQT,UAJM;AAKdU,YAAM;AALQ,KAAhB;AAOAX,SAAKQ,QAAQd,OAAb;AACD,GAfD;AAiBAC,SAAOa,KAAP,GAAenC,gBAAf;AACAsB,SAAOe,MAAP,GAAgB,CAACX,MAAM,CAAP,KAAaE,aAAaP,OAA1B,CAAhB;AAEAX,eAAaC,GAAb,EAAkBC,UAAlB,EAA8BC,QAA9B;;AACA,OAAK,MAAMoB,IAAX,IAAmBJ,OAAnB,EAA4B;AAC1BlB,QAAI4B,QAAJ,CAAaN,IAAb,EAAmBJ,QAAQI,IAAR,EAAcN,CAAjC,EAAoCE,QAAQI,IAAR,EAAcG,CAAd,GAAkBvB,WAAWV,cAAjE;AACD;;AAED,SAAO;AACLqC,WAAOpC,YADF;AAELyB,WAFK;AAGLY,aAAS,IAAI7C,SAAJ,CAAcuB,EAAd,EAAkB;AACzBuB,cAAQpB,MADiB;AAEzB;AACA;AACAqB,kBAAY;AACV,SAAC9C,iBAAD,GAAqBE,gBADX;AAEV,SAACD,iBAAD,GAAqBC;AAFX;AAJa,KAAlB;AAHJ,GAAP;AAaD","sourcesContent":["/* global document */\nimport {Texture2D} from 'luma.gl';\n\nconst GL_TEXTURE_WRAP_S = 0x2802;\nconst GL_TEXTURE_WRAP_T = 0x2803;\nconst GL_CLAMP_TO_EDGE = 0x812f;\nconst MAX_CANVAS_WIDTH = 1024;\nconst DEFAULT_FONT_SIZE = 64;\nconst DEFAULT_PADDING = 4;\n\nconst BASELINE_SCALE = 0.9;\nconst HEIGHT_SCALE = 1.2;\n\nexport const DEFAULT_CHAR_SET = [];\nfor (let i = 32; i < 128; i++) {\n  DEFAULT_CHAR_SET.push(String.fromCharCode(i));\n}\n\nfunction setTextStyle(ctx, fontFamily, fontSize) {\n  ctx.font = `${fontSize}px ${fontFamily}`;\n  ctx.fillStyle = '#000';\n  ctx.textBaseline = 'baseline';\n  ctx.textAlign = 'left';\n}\n\nexport function makeFontAtlas(\n  gl,\n  {\n    fontFamily,\n    characterSet = DEFAULT_CHAR_SET,\n    fontSize = DEFAULT_FONT_SIZE,\n    padding = DEFAULT_PADDING\n  }\n) {\n  const canvas = document.createElement('canvas');\n  const ctx = canvas.getContext('2d');\n\n  // measure texts\n  let row = 0;\n  let x = 0;\n  // TODO - use Advanced text metrics when they are adopted:\n  // https://developer.mozilla.org/en-US/docs/Web/API/TextMetrics\n  const fontHeight = fontSize * HEIGHT_SCALE;\n  setTextStyle(ctx, fontFamily, fontSize);\n  const mapping = {};\n\n  Array.from(characterSet).forEach(char => {\n    const {width} = ctx.measureText(char);\n\n    if (x + width > MAX_CANVAS_WIDTH) {\n      x = 0;\n      row++;\n    }\n    mapping[char] = {\n      x,\n      y: row * (fontHeight + padding),\n      width,\n      height: fontHeight,\n      mask: true\n    };\n    x += width + padding;\n  });\n\n  canvas.width = MAX_CANVAS_WIDTH;\n  canvas.height = (row + 1) * (fontHeight + padding);\n\n  setTextStyle(ctx, fontFamily, fontSize);\n  for (const char in mapping) {\n    ctx.fillText(char, mapping[char].x, mapping[char].y + fontSize * BASELINE_SCALE);\n  }\n\n  return {\n    scale: HEIGHT_SCALE,\n    mapping,\n    texture: new Texture2D(gl, {\n      pixels: canvas,\n      // padding is added only between the characters but not for borders\n      // enforce CLAMP_TO_EDGE to avoid any artifacts.\n      parameters: {\n        [GL_TEXTURE_WRAP_S]: GL_CLAMP_TO_EDGE,\n        [GL_TEXTURE_WRAP_T]: GL_CLAMP_TO_EDGE\n      }\n    })\n  };\n}\n"],"file":"font-atlas.js"}