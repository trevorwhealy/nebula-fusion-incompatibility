{"version":3,"sources":["../../../src/lib/attribute.js"],"names":["DEFAULT_STATE","isExternalBuffer","needsUpdate","needsRedraw","allocedInstances","LayerAttribute","gl","opts","transition","noAlloc","update","accessor","bufferLayout","defaultValue","Array","isArray","Object","assign","userData","seal","_validateAttributeUpdaters","clearChangedFlags","value","length","size","id","concat","settings","find","a","Number","isFinite","duration","reason","numInstances","state","instanceCount","getInstanceCount","needsAlloc","allocCount","Math","max","ArrayType","glArrayFromType","type","GL","FLOAT","constant","data","props","context","updated","call","_checkAttributeArray","_updateBufferViaStandardAccessor","undefined","_normalizeValue","hasChanged","_areValuesEqual","buffer","Buffer","externalBuffer","Error","name","auto","out","start","ArrayBuffer","isView","value1","value2","i","accessorFunc","object","objectValue","hasUpdater","valid","layout","Attribute","glType","clamped","Float32Array","UNSIGNED_SHORT","UNSIGNED_SHORT_5_6_5","UNSIGNED_SHORT_4_4_4_4","UNSIGNED_SHORT_5_5_5_1","Uint16Array","UNSIGNED_INT","Uint32Array","UNSIGNED_BYTE","Uint8ClampedArray","Uint8Array","BYTE","Int8Array","SHORT","Int16Array","INT","Int32Array"],"mappings":"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","sourcesContent":["/* eslint-disable complexity */\nimport assert from '../utils/assert';\nimport GL from 'luma.gl/constants';\nimport {Buffer, _Attribute as Attribute} from 'luma.gl';\n\nconst DEFAULT_STATE = {\n  isExternalBuffer: false,\n  needsUpdate: true,\n  needsRedraw: false,\n  allocedInstances: -1\n};\n\nexport default class LayerAttribute extends Attribute {\n  constructor(gl, opts = {}) {\n    super(gl, opts);\n\n    const {\n      // deck.gl fields\n      transition = false,\n      noAlloc = false,\n      update = null,\n      accessor = null,\n      bufferLayout = null\n    } = opts;\n\n    let {defaultValue = [0, 0, 0, 0]} = opts;\n    defaultValue = Array.isArray(defaultValue) ? defaultValue : [defaultValue];\n\n    Object.assign(this.userData, DEFAULT_STATE, opts, {\n      transition,\n      noAlloc,\n      update,\n      accessor,\n      defaultValue,\n      bufferLayout\n    });\n\n    Object.seal(this.userData);\n\n    // Check all fields and generate helpful error messages\n    this._validateAttributeUpdaters();\n  }\n\n  get bufferLayout() {\n    return this.userData.bufferLayout;\n  }\n\n  set bufferLayout(layout) {\n    this.userData.bufferLayout = layout;\n  }\n\n  needsUpdate() {\n    return this.userData.needsUpdate;\n  }\n\n  needsRedraw({clearChangedFlags = false} = {}) {\n    const needsRedraw = this.userData.needsRedraw;\n    this.userData.needsRedraw = this.userData.needsRedraw && !clearChangedFlags;\n    return needsRedraw;\n  }\n\n  getInstanceCount() {\n    return this.value !== null ? this.value.length / this.size : 0;\n  }\n\n  getUpdateTriggers() {\n    const {accessor} = this.userData;\n\n    // Backards compatibility: allow attribute name to be used as update trigger key\n    return [this.id].concat(accessor || []);\n  }\n\n  getAccessor() {\n    return this.userData.accessor;\n  }\n\n  supportsTransition() {\n    return this.userData.transition;\n  }\n\n  // Resolve transition settings object if transition is enabled, otherwise `null`\n  getTransitionSetting(opts) {\n    const {transition, accessor} = this.userData;\n    if (!transition) {\n      return null;\n    }\n    let settings = Array.isArray(accessor) ? opts[accessor.find(a => opts[a])] : opts[accessor];\n\n    // Shorthand: use duration instead of parameter object\n    if (Number.isFinite(settings)) {\n      settings = {duration: settings};\n    }\n\n    if (settings && settings.duration > 0) {\n      return Object.assign({}, transition, settings);\n    }\n\n    return null;\n  }\n\n  // Checks that typed arrays for attributes are big enough\n  // sets alloc flag if not\n  // @return {Boolean} whether any updates are needed\n  setNeedsUpdate(reason = this.id) {\n    this.userData.needsUpdate = this.userData.needsUpdate || reason;\n  }\n\n  setNeedsRedraw(reason = this.id) {\n    this.userData.needsRedraw = this.userData.needsRedraw || reason;\n  }\n\n  allocate(numInstances) {\n    const state = this.userData;\n\n    if (state.isExternalBuffer || state.noAlloc) {\n      // Data is provided through a Buffer object.\n      return false;\n    }\n\n    // Do we need to reallocate the attribute's typed array?\n    const instanceCount = this.getInstanceCount();\n    const needsAlloc = instanceCount === 0 || instanceCount < numInstances;\n    if (needsAlloc && (state.update || state.accessor)) {\n      assert(Number.isFinite(numInstances));\n      // Allocate at least one element to ensure a valid buffer\n      const allocCount = Math.max(numInstances, 1);\n      const ArrayType = glArrayFromType(this.type || GL.FLOAT);\n\n      this.constant = false;\n      this.value = new ArrayType(this.size * allocCount);\n      state.needsUpdate = true;\n      state.allocedInstances = allocCount;\n      return true;\n    }\n\n    return false;\n  }\n\n  updateBuffer({numInstances, data, props, context}) {\n    if (!this.needsUpdate()) {\n      return false;\n    }\n\n    const state = this.userData;\n\n    const {update, accessor} = state;\n\n    let updated = true;\n    if (update) {\n      // Custom updater - typically for non-instanced layers\n      update.call(context, this, {data, props, numInstances});\n      this.update({\n        value: this.value,\n        constant: this.constant\n      });\n      this._checkAttributeArray();\n    } else if (accessor) {\n      // Standard updater\n      this._updateBufferViaStandardAccessor(data, props);\n      this._checkAttributeArray();\n    } else {\n      updated = false;\n    }\n\n    state.needsUpdate = false;\n    state.needsRedraw = true;\n\n    return updated;\n  }\n\n  // Use generic value\n  // Returns true if successful\n  setGenericValue(value) {\n    const state = this.userData;\n\n    if (value === undefined || typeof value === 'function') {\n      // ignore if this attribute has no accessor\n      // ignore if accessor is function, will be used in updateBuffer\n      state.isExternalBuffer = false;\n      return false;\n    }\n\n    value = this._normalizeValue(value);\n    const hasChanged = !this.constant || !this._areValuesEqual(value, this.value);\n\n    if (hasChanged) {\n      this.update({constant: true, value});\n    }\n    state.needsRedraw = state.needsUpdate || hasChanged;\n    state.needsUpdate = false;\n    state.isExternalBuffer = true;\n    return true;\n  }\n\n  // Use external buffer\n  // Returns true if successful\n  setExternalBuffer(buffer, numInstances) {\n    const state = this.userData;\n\n    if (buffer) {\n      state.isExternalBuffer = true;\n      state.needsUpdate = false;\n\n      if (buffer instanceof Buffer) {\n        if (this.externalBuffer !== buffer) {\n          this.update({constant: false, buffer});\n          state.needsRedraw = true;\n        }\n      } else {\n        const ArrayType = glArrayFromType(this.type || GL.FLOAT);\n        if (!(buffer instanceof ArrayType)) {\n          throw new Error(`Attribute ${this.id} must be of type ${ArrayType.name}`);\n        }\n        if (state.auto && buffer.length <= numInstances * this.size) {\n          throw new Error('Attribute prop array must match length and size');\n        }\n        if (this.value !== buffer) {\n          this.update({constant: false, value: buffer});\n          state.needsRedraw = true;\n        }\n      }\n      return true;\n    }\n\n    state.isExternalBuffer = false;\n    return false;\n  }\n\n  // PRIVATE HELPER METHODS\n\n  /* check user supplied values and apply fallback */\n  _normalizeValue(value, out = [], start = 0) {\n    const {defaultValue} = this.userData;\n\n    if (!Array.isArray(value) && !ArrayBuffer.isView(value)) {\n      out[start] = Number.isFinite(value) ? value : defaultValue[0];\n      return out;\n    }\n\n    /* eslint-disable no-fallthrough, default-case */\n    switch (this.size) {\n      case 4:\n        out[start + 3] = Number.isFinite(value[3]) ? value[3] : defaultValue[3];\n      case 3:\n        out[start + 2] = Number.isFinite(value[2]) ? value[2] : defaultValue[2];\n      case 2:\n        out[start + 1] = Number.isFinite(value[1]) ? value[1] : defaultValue[1];\n      case 1:\n        out[start + 0] = Number.isFinite(value[0]) ? value[0] : defaultValue[0];\n    }\n\n    return out;\n  }\n\n  _areValuesEqual(value1, value2, size = this.size) {\n    for (let i = 0; i < size; i++) {\n      if (value1[i] !== value2[i]) {\n        return false;\n      }\n    }\n    return true;\n  }\n\n  _updateBufferViaStandardAccessor(data, props) {\n    const state = this.userData;\n\n    const {accessor} = state;\n    const {value, size} = this;\n    const accessorFunc = props[accessor];\n\n    assert(typeof accessorFunc === 'function', `accessor \"${accessor}\" is not a function`);\n\n    let i = 0;\n    for (const object of data) {\n      const objectValue = accessorFunc(object);\n      this._normalizeValue(objectValue, value, i);\n      i += size;\n    }\n    this.update({value});\n  }\n\n  // Validate deck.gl level fields\n  _validateAttributeUpdaters() {\n    const state = this.userData;\n\n    // Check that either 'accessor' or 'update' is a valid function\n    const hasUpdater =\n      state.noAlloc || typeof state.update === 'function' || typeof state.accessor === 'string';\n    if (!hasUpdater) {\n      throw new Error(`Attribute ${this.id} missing update or accessor`);\n    }\n  }\n\n  _checkAttributeArray() {\n    const {value} = this;\n    if (value && value.length >= 4) {\n      const valid =\n        Number.isFinite(value[0]) &&\n        Number.isFinite(value[1]) &&\n        Number.isFinite(value[2]) &&\n        Number.isFinite(value[3]);\n      if (!valid) {\n        throw new Error(`Illegal attribute generated for ${this.id}`);\n      }\n    }\n  }\n}\n\n/* eslint-disable complexity */\nexport function glArrayFromType(glType, {clamped = true} = {}) {\n  // Sorted in some order of likelihood to reduce amount of comparisons\n  switch (glType) {\n    case GL.FLOAT:\n      return Float32Array;\n    case GL.UNSIGNED_SHORT:\n    case GL.UNSIGNED_SHORT_5_6_5:\n    case GL.UNSIGNED_SHORT_4_4_4_4:\n    case GL.UNSIGNED_SHORT_5_5_5_1:\n      return Uint16Array;\n    case GL.UNSIGNED_INT:\n      return Uint32Array;\n    case GL.UNSIGNED_BYTE:\n      return clamped ? Uint8ClampedArray : Uint8Array;\n    case GL.BYTE:\n      return Int8Array;\n    case GL.SHORT:\n      return Int16Array;\n    case GL.INT:\n      return Int32Array;\n    default:\n      throw new Error('Failed to deduce type from array');\n  }\n}\n/* eslint-enable complexity */\n"],"file":"attribute.js"}